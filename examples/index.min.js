!function(){"use strict";class t{constructor(t=0,s=0){this.x=t,this.y=s,window.vec2Total++}set(t=0,s=0){this.x=t,this.y=s}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}mul(t){this.x*=t,this.y*=t}static add(s,i){return new t(s.x+i.x,s.y+i.y)}static sub(s,i){return new t(s.x-i.x,s.y-i.y)}static mulVV(s,i){return new t(s.x*i.x,s.y*i.y)}static mulSV(s,i){return new t(s*i.x,s*i.y)}static abs(s){return new t(Math.abs(s.x),Math.abs(s.y))}static neg(s){return new t(-s.x,-s.y)}static dot(t,s){return t.x*s.x+t.y*s.y}static dotXYV(t,s,i){return t*i.x+s*i.y}static dotXY(t,s,i,e){return t*i+s*e}static crossVV(t,s){return t.x*s.y-t.y*s.x}static crossVXY(t,s,i){return t.x*i-t.y*s}static crossVS(s,i){return new t(i*s.y,-i*s.x)}static crossSV(s,i){return new t(-s*i.y,s*i.x)}}class s{constructor(s,i){this.position=new t,this.rotation=0,this.velocity=new t,this.angularVelocity=0,this.force=new t,this.torque=0,this.width=new t,this.friction=.2,this.mass=Number.MAX_VALUE,this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0,this.id=0,this.set(s,i)}set(t,s){return this.width=t,this.mass=s,s<Number.MAX_VALUE?(this.invMass=1/s,this.I=s*(t.x*t.x+t.y*t.y)/12,this.invI=1/this.I):(this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0),this}addForce(t){return this.force.add(t),this}}class i{constructor(t=0,s=0,i=0,e=0){this.a=t,this.c=s,this.b=i,this.d=e,window.mat22Total++}set(t){const s=Math.cos(t),i=Math.sin(t);return this.a=s,this.c=i,this.b=-i,this.d=s,this}setFromVec2(t,s){return this.a=t.x,this.c=t.y,this.b=s.x,this.d=s.y,this}static add(t,s){return new i(t.a+s.a,t.c+s.c,t.b+s.b,t.d+s.d)}static mulMV(s,i){return new t(s.a*i.x+s.b*i.y,s.c*i.x+s.d*i.y)}static mulMM(t,s){const e=t.a*s.a+t.c*s.c,n=t.b*s.a+t.d*s.c,o=t.a*s.b+t.c*s.d,a=t.b*s.b+t.d*s.d;return new i(e,n,o,a)}static abs(t){return new i(Math.abs(t.a),Math.abs(t.c),Math.abs(t.b),Math.abs(t.d))}static transpose(t){return new i(t.a,t.b,t.c,t.d)}static invert(t){const s=t.a,e=t.c,n=t.b,o=t.d;let a=1/(s*o-n*e);return new i(a*o,a*-n,a*-e,a*s)}}function e(t,s,i){return Math.max(s,Math.min(t,i))}var n,o;!function(t){t[t.FACE_A_X=0]="FACE_A_X",t[t.FACE_A_Y=1]="FACE_A_Y",t[t.FACE_B_X=2]="FACE_B_X",t[t.FACE_B_Y=3]="FACE_B_Y"}(n||(n={})),function(t){t[t.NO_EDGE=0]="NO_EDGE",t[t.EDGE1=1]="EDGE1",t[t.EDGE2=2]="EDGE2",t[t.EDGE3=3]="EDGE3",t[t.EDGE4=4]="EDGE4"}(o||(o={}));class a{constructor(){this.inEdge1=o.NO_EDGE,this.outEdge1=o.NO_EDGE,this.inEdge2=o.NO_EDGE,this.outEdge2=o.NO_EDGE}}class r{constructor(){this.e=new a,this.value=0}flip(){const t=this.e,s=t.inEdge1,i=t.outEdge1;t.inEdge1=t.inEdge2,t.inEdge2=s,t.outEdge1=t.outEdge2,t.outEdge2=i}}class l{constructor(){this.v=new t,this.fp=new r}}function h(t,s,i,e,n,a){const r=-(e.a*n+e.c*a),h=-(e.b*n+e.d*a),c=Math.abs(r),d=Math.abs(h),u=new l,y=new l;c>d?Math.sign(r)>0?(u.v.set(s.x,-s.y),u.fp.e.inEdge2=o.EDGE3,u.fp.e.outEdge2=o.EDGE4,y.v.set(s.x,s.y),y.fp.e.inEdge2=o.EDGE4,y.fp.e.outEdge2=o.EDGE1):(u.v.set(-s.x,s.y),u.fp.e.inEdge2=o.EDGE1,u.fp.e.outEdge2=o.EDGE2,y.v.set(-s.x,-s.y),y.fp.e.inEdge2=o.EDGE2,y.fp.e.outEdge2=o.EDGE3):Math.sign(h)>0?(u.v.set(s.x,s.y),u.fp.e.inEdge2=o.EDGE4,u.fp.e.outEdge2=o.EDGE1,y.v.set(-s.x,s.y),y.fp.e.inEdge2=o.EDGE1,y.fp.e.outEdge2=o.EDGE2):(u.v.set(-s.x,-s.y),u.fp.e.inEdge2=o.EDGE2,u.fp.e.outEdge2=o.EDGE3,y.v.set(s.x,-s.y),y.fp.e.inEdge2=o.EDGE3,y.fp.e.outEdge2=o.EDGE4);const v=u.v,E=y.v;let b=i.x+(e.a*v.x+e.b*v.y),x=i.y+(e.c*v.x+e.d*v.y);v.set(b,x),b=i.x+(e.a*E.x+e.b*E.y),x=i.y+(e.c*E.x+e.d*E.y),E.set(b,x),t[0]=u,t[1]=y}class c{constructor(){this.position=new t,this.normal=new t,this.r1=new t,this.r2=new t,this.separation=0,this.Pn=0,this.Pt=0,this.Pnb=0,this.massNormal=0,this.massTangent=0,this.bias=0,this.feature=new r}}function d(s,i,e,n,a,r){let h=0,c=t.dotXYV(e,n,i[0].v)-a,d=t.dotXYV(e,n,i[1].v)-a;if(c<=0&&(s[h]=i[0],h++),d<=0&&(s[h]=i[1],h++),c*d<0){let t=c/(c-d),e=new l;e.v.set(i[0].v.x+t*(i[1].v.x-i[0].v.x),i[0].v.y+t*(i[1].v.y-i[0].v.y)),c>0?(e.fp=i[0].fp,e.fp.e.inEdge1=r,e.fp.e.inEdge2=o.NO_EDGE):(e.fp=i[1].fp,e.fp.e.outEdge1=r,e.fp.e.outEdge2=o.NO_EDGE),s[h]=e,h++}return h}function u(s,e,a){let r=t.mulSV(.5,e.width),l=t.mulSV(.5,a.width),u=e.position,y=a.position,v=(new i).set(e.rotation),E=(new i).set(a.rotation),b=i.transpose(v),x=i.transpose(E),m=t.sub(y,u),w=i.mulMV(b,m),p=i.mulMV(x,m),M=i.mulMM(b,E),f=i.abs(M),g=i.transpose(f),V=t.sub(t.sub(t.abs(w),r),i.mulMV(f,l));if(V.x>0||V.y>0)return 0;let _=t.sub(t.sub(t.abs(p),i.mulMV(g,r)),l);if(_.x>0||_.y>0)return 0;let A=n.FACE_A_X,I=V.x,D=0,G=0;w.x>0?(D=v.a,G=v.c):(D=-v.a,G=-v.c);V.y>.95*I+.01*r.y&&(A=n.FACE_A_Y,I=V.y,w.y>0?(D=v.b,G=v.d):(D=-v.b,G=-v.d)),_.x>.95*I+.01*l.x&&(A=n.FACE_B_X,I=_.x,p.x>0?(D=E.a,G=E.c):(D=-E.a,G=-E.c)),_.y>.95*I+.01*l.y&&(A=n.FACE_B_Y,I=_.y,p.y>0?(D=E.b,G=E.d):(D=-E.b,G=-E.d));let S=D,P=G,X=[],C=null;if(A===n.FACE_A_X?C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,s)+a.x,v=e.b,E=e.d,b=t.dotXYV(v,E,s),x=-b+a.y,m=b+a.y,w=[];h(w,r,i,n,l,c);let p=[],M=d(p,w,-v,-E,x,o.EDGE3);return M<2?null:(M=d(u,p,v,E,m,o.EDGE1),M<2?null:y)}(u,y,v,E,r,l,S,P,X):A===n.FACE_A_Y?C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,s)+a.y,v=e.a,E=e.c,b=t.dotXYV(v,E,s),x=-b+a.x,m=b+a.x,w=[];h(w,r,i,n,l,c);let p=[],M=d(p,w,-v,-E,x,o.EDGE2);return M<2?null:(M=d(u,p,v,E,m,o.EDGE4),M<2?null:y)}(u,y,v,E,r,l,S,P,X):A===n.FACE_B_X?(S=-D,P=-G,C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,i)+r.x,v=n.b,E=n.d,b=t.dotXYV(v,E,i),x=-b+r.y,m=b+r.y,w=[];h(w,a,s,e,l,c);let p=[],M=d(p,w,-v,-E,x,o.EDGE3);return M<2?null:(M=d(u,p,v,E,m,o.EDGE1),M<2?null:y)}(u,y,v,E,r,l,S,P,X)):A===n.FACE_B_Y&&(S=-D,P=-G,C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,i)+r.y,v=n.a,E=n.c,b=t.dotXYV(v,E,i),x=-b+r.x,m=b+r.x,w=[];h(w,a,s,e,l,c);let p=[],M=d(p,w,-v,-E,x,o.EDGE2);return M<2?null:(M=d(u,p,v,E,m,o.EDGE4),M<2?null:y)}(u,y,v,E,r,l,S,P,X)),null===C)return 0;let Y=0;for(let i=0;i<2;i++){let e=t.dotXYV(S,P,X[i].v)-C;e<=0&&(s[Y]=new c,s[Y].separation=e,s[Y].normal.set(D,G),s[Y].position=new t(X[i].v.x-e*S,X[i].v.y-e*P),s[Y].feature=X[i].fp,A!==n.FACE_B_X&&A!==n.FACE_B_Y||s[Y].feature.flip(),Y++)}return Y}class y{constructor(t,s,i){this.world=t,s.id<i.id?(this.body1=s,this.body2=i):(this.body1=i,this.body2=s),this.contacts=[],this.numContacts=u(this.contacts,this.body1,this.body2),this.friction=Math.sqrt(this.body1.friction*this.body2.friction)}update(t,s){let i=[],e=this.contacts,n=this.numContacts,o=this.world.warmStarting;for(let a=0;a<s;a++){let s=t[a],r=-1;for(let t=0;t<n;t++){let i=e[t];if(s.feature.value===i.feature.value){r=t;break}}if(r>-1){let t=e[r];o?(s.Pn=t.Pn,s.Pt=t.Pt,s.Pnb=t.Pnb):(s.Pn=0,s.Pt=0,s.Pnb=0),i[a]=s}else i[a]=t[a]}this.contacts=i,this.numContacts=s}preStep(s){let i=this.contacts,e=this.numContacts,n=this.world.positionCorrection?.2:0,o=this.body1,a=this.body2,r=this.world.accumulateImpulses;for(let l=0;l<e;l++){let e=i[l],h=t.sub(e.position,o.position),c=t.sub(e.position,a.position),d=t.dot(h,e.normal),u=t.dot(c,e.normal),y=o.invMass+a.invMass;y+=o.invI*(t.dot(h,h)-d*d)+a.invI*(t.dot(c,c)-u*u),e.massNormal=1/y;let v=t.crossVS(e.normal,1),E=t.dot(h,v),b=t.dot(c,v),x=o.invMass+a.invMass;if(x+=o.invI*(t.dot(h,h)-E*E)+a.invI*(t.dot(c,c)-b*b),e.massTangent=1/x,e.bias=-n*s*Math.min(0,e.separation+.01),r){let s=t.add(t.mulSV(e.Pn,e.normal),t.mulSV(e.Pt,v));o.velocity.sub(t.mulSV(o.invMass,s)),o.angularVelocity-=o.invI*t.crossVV(h,s),a.velocity.add(t.mulSV(a.invMass,s)),a.angularVelocity+=a.invI*t.crossVV(c,s)}}}applyImpulse(){let s=this.contacts,i=this.numContacts,n=this.body1,o=this.body2,a=this.world.accumulateImpulses;for(let r=0;r<i;r++){let i=s[r],l=i.r1,h=i.r2;l.set(i.position.x-n.position.x,i.position.y-n.position.y),h.set(i.position.x-o.position.x,i.position.y-o.position.y);let c=-o.angularVelocity*h.y,d=o.angularVelocity*h.x,u=-n.angularVelocity*l.y,y=n.angularVelocity*l.x,v=o.velocity.x+c,E=o.velocity.y+d,b=v-n.velocity.x-u,x=E-n.velocity.y-y,m=t.dotXYV(b,x,i.normal),w=i.massNormal*(-m+i.bias);if(a){let t=i.Pn;i.Pn=Math.max(t+w,0),w=i.Pn-t}else w=Math.max(w,0);let p=w*i.normal.x,M=w*i.normal.y;n.velocity.x-=n.invMass*p,n.velocity.y-=n.invMass*M,n.angularVelocity-=n.invI*t.crossVXY(i.r1,p,M),o.velocity.x+=o.invMass*p,o.velocity.y+=o.invMass*M,o.angularVelocity+=o.invI*t.crossVXY(i.r2,p,M);let f=t.crossVS(i.normal,1),g=t.dotXYV(b,x,f),V=i.massTangent*-g;if(a){let t=this.friction*i.Pn,s=i.Pt;i.Pt=e(s+V,-t,t),V=i.Pt-s}else{let t=this.friction*w;V=e(V,-t,t)}p=V*f.x,M=V*f.y,n.velocity.x-=n.invMass*p,n.velocity.y-=n.invMass*M,n.angularVelocity-=n.invI*t.crossVXY(i.r1,p,M),o.velocity.x+=o.invMass*p,o.velocity.y+=o.invMass*M,o.angularVelocity+=o.invI*t.crossVXY(i.r2,p,M)}}}class v{constructor(t,s){this.bodyA=t,this.bodyB=s,this.value=t.id+":"+s.id}}class E{constructor(t,s){this.first=t,this.second=s}}window.vec2Total=0,window.mat22Total=0;let b,x=new class{constructor(s=new t(0,9.807),i=10){this.bodyIdSeed=0,this.bodies=[],this.joints=[],this.arbiters=[],this.gravity=new t,this.iterations=10,this.accumulateImpulses=!0,this.warmStarting=!0,this.positionCorrection=!0,this.gravity.x=s.x,this.gravity.y=s.y,this.iterations=i}addBody(t){return this.bodyIdSeed++,t.id=this.bodyIdSeed,this.bodies.push(t),this}addJoint(t){return this.joints.push(t),this}clear(){return this.bodies=[],this.joints=[],this.arbiters=[],this}broadPhase(){let t=this.bodies,s=t.length,i=this.arbiters;for(let e=0;e<s-1;e++){let n=t[e];for(let o=e+1;o<s;o++){let s=t[o];if(0===n.invMass&&0===s.invMass)continue;let e=new y(this,n,s),a=new v(n,s),r=-1;for(let t=0;t<i.length;t++)if(i[t].first.value===a.value){r=t;break}e.numContacts>0?-1===r?i.push(new E(a,e)):i[r].second.update(e.contacts,e.numContacts):0===e.numContacts&&r>-1&&i.splice(r,1)}}}step(s){let i=s>0?1/s:0;this.broadPhase();const e=this.bodies,n=this.gravity;for(let i=0;i<e.length;i++){let o=e[i];0!==o.invMass&&(o.velocity.add(t.mulSV(s,t.add(n,t.mulSV(o.invMass,o.force)))),o.angularVelocity+=s*o.invI*o.torque)}const o=this.arbiters,a=this.joints;for(let t=0;t<o.length;t++)o[t].second.preStep(i);for(let t=0;t<a.length;t++)a[t].preStep(i);for(let t=0;t<this.iterations;t++){for(let t=0;t<o.length;t++)o[t].second.applyImpulse();for(let t=0;t<a.length;t++)a[t].applyImpulse()}for(let i=0;i<e.length;i++){let n=e[i];n.position.add(t.mulSV(s,n.velocity)),n.rotation+=s*n.angularVelocity,n.force.set(0,0),n.torque=0}}}(new t(0,40),10),m=new s(new t(2e3,80),Number.MAX_VALUE);m.position.set(500,500),x.addBody(m);let w=new t(300,-150);for(let i=0;i<10;i++)for(let e=0;e<10;e++)b=new s(new t(12,12),5),b.position.set(w.x+16*i,w.y+16*e),b.velocity.y=-50+e,x.addBody(b);let p=new s(new t(25,25),Number.MAX_VALUE);p.position.set(530,50),x.addBody(p);let M=new s(new t(50,50),900);M.position.set(685,40),x.addBody(M);let f=new class{constructor(){this.M=new i,this.localAnchor1=new t,this.localAnchor2=new t,this.r1=new t,this.r2=new t,this.bias=new t,this.P=new t,this.biasFactor=.2,this.softness=0}set(s,e,n,o){this.world=s,this.body1=e,this.body2=n;let a=(new i).set(e.rotation),r=(new i).set(n.rotation),l=i.transpose(a),h=i.transpose(r);this.localAnchor1=i.mulMV(l,t.sub(o,e.position)),this.localAnchor2=i.mulMV(h,t.sub(o,n.position))}preStep(s){const e=this.body1,n=this.body2;let o=(new i).set(e.rotation),a=(new i).set(n.rotation),r=i.mulMV(o,this.localAnchor1),l=i.mulMV(a,this.localAnchor2),h=new i(e.invMass+n.invMass,0,0,e.invMass+n.invMass),c=new i(e.invI*r.y*r.y,-e.invI*r.x*r.y,-e.invI*r.x*r.y,e.invI*r.x*r.x),d=new i(n.invI*l.y*l.y,-n.invI*l.x*l.y,-n.invI*l.x*l.y,n.invI*l.x*l.x),u=i.add(i.add(h,c),d);u.a+=this.softness,u.d+=this.softness,this.M=i.invert(u);let y=t.add(e.position,r),v=t.add(n.position,l),E=t.sub(v,y);this.world.positionCorrection?this.bias=t.mulSV(-this.biasFactor,t.mulSV(s,E)):this.bias.set(0,0),this.world.warmStarting?(e.velocity.sub(t.mulSV(e.invMass,this.P)),e.angularVelocity-=e.invI*t.crossVV(r,this.P),n.velocity.add(t.mulSV(n.invMass,this.P)),n.angularVelocity+=n.invI*t.crossVV(l,this.P)):this.P.set(0,0),this.r1=r,this.r2=l}applyImpulse(){const s=this.body1,e=this.body2,n=this.r1,o=this.r2;let a=t.sub(t.sub(t.add(e.velocity,t.crossSV(e.angularVelocity,o)),s.velocity),t.crossSV(s.angularVelocity,n)),r=new t;r=i.mulMV(this.M,t.sub(t.sub(this.bias,a),t.mulSV(this.softness,this.P))),s.velocity.sub(t.mulSV(s.invMass,r)),s.angularVelocity-=s.invI*t.crossVV(n,r),e.velocity.add(t.mulSV(e.invMass,r)),e.angularVelocity+=e.invI*t.crossVV(o,r),this.P.add(r)}};f.set(x,p,M,p.position),x.addJoint(f);let g=new class{constructor(s){this.canvas=s,this.context=s.getContext("2d"),this._M0=new i,this._M1=new i,this._v1=new t,this._v2=new t,this._v3=new t,this._v4=new t,this._orientation=new t}render(t){const s=this.context,i=t.bodies,e=t.joints,n=t.arbiters;s.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<i.length;t++)this.renderBody(i[t],s);for(let t=0;t<n.length;t++){let i=n[t].second;for(let t=0;t<i.contacts.length;t++)this.renderContact(i.contacts[t],s)}for(let t=0;t<e.length;t++)this.renderJoint(e[t],s)}renderBody(t,s){this._M0.set(t.rotation);let i=t.position,e=.5*t.width.x,n=.5*t.width.y;const o=this._v1,a=this._v2,r=this._v3,l=this._v4;o.set(i.x+(this._M0.a*-e+this._M0.b*-n),i.y+(this._M0.c*-e+this._M0.d*-n)),a.set(i.x+(this._M0.a*e+this._M0.b*-n),i.y+(this._M0.c*e+this._M0.d*-n)),r.set(i.x+(this._M0.a*e+this._M0.b*n),i.y+(this._M0.c*e+this._M0.d*n)),l.set(i.x+(this._M0.a*-e+this._M0.b*n),i.y+(this._M0.c*-e+this._M0.d*n));const h=this._orientation;h.set(i.x+this._M0.a*e,i.y+this._M0.c*e),s.strokeStyle="black",s.lineWidth=.5,s.beginPath(),s.arc(t.position.x,t.position.y,2,0,2*Math.PI),s.moveTo(o.x,o.y),s.lineTo(a.x,a.y),s.lineTo(r.x,r.y),s.lineTo(l.x,l.y),s.lineTo(o.x,o.y),s.moveTo(i.x,i.y),s.lineTo(h.x,h.y),s.stroke()}renderContact(t,s){s.strokeStyle="red",s.lineWidth=.5,s.beginPath(),s.arc(t.position.x,t.position.y,2,0,2*Math.PI),s.stroke()}renderJoint(t,s){let i=t.body1,e=t.body2;this._M0.set(i.rotation),this._M1.set(e.rotation);let n=i.position,o=e.position;const a=this._v1,r=this._v2;a.set(n.x+(this._M0.a*t.localAnchor1.x+this._M0.b*t.localAnchor1.y),n.y+(this._M0.c*t.localAnchor1.x+this._M0.d*t.localAnchor1.y)),r.set(o.x+(this._M1.a*t.localAnchor2.x+this._M1.b*t.localAnchor2.y),o.y+(this._M1.c*t.localAnchor2.x+this._M1.d*t.localAnchor2.y)),s.beginPath(),s.moveTo(n.x,n.y),s.lineTo(a.x,a.y),s.lineTo(o.x,o.y),s.lineTo(r.x,r.y),s.stroke()}}(document.getElementById("demo")),V=!0,_=0,A=document.getElementById("frame"),I=document.getElementById("vec2"),D=document.getElementById("mat22"),G=document.getElementById("frame200"),S=document.getElementById("frame600");document.getElementById("pause").addEventListener("click",()=>{V=!V}),function t(){window.vec2Total=0,window.mat22Total=0,V||(x.step(1/30),g.render(x),A.value=_.toString(),I.value=window.vec2Total.toString(),D.value=window.mat22Total.toString(),200===_?G.value="vec2: "+I.value+" mat22: "+D.value+" arbiters: "+x.arbiters.length+" bodies: "+x.bodies.length:600===_&&(S.value="vec2: "+I.value+" mat22: "+D.value+" arbiters: "+x.arbiters.length+" bodies: "+x.bodies.length),_++),requestAnimationFrame(t)}()}();
