!function(){"use strict";class t{constructor(t=0,s=0){this.x=t,this.y=s,window.vec2Total++}set(t=0,s=0){this.x=t,this.y=s}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}mul(t){this.x*=t,this.y*=t}static add(s,e){return new t(s.x+e.x,s.y+e.y)}static sub(s,e){return new t(s.x-e.x,s.y-e.y)}static mulVV(s,e){return new t(s.x*e.x,s.y*e.y)}static mulSV(s,e){return new t(s*e.x,s*e.y)}static abs(s){return new t(Math.abs(s.x),Math.abs(s.y))}static neg(s){return new t(-s.x,-s.y)}static dot(t,s){return t.x*s.x+t.y*s.y}static crossVV(t,s){return t.x*s.y-t.y*s.x}static crossVS(s,e){return new t(e*s.y,-e*s.x)}static crossSV(s,e){return new t(-s*e.y,s*e.x)}}class s{constructor(s,e){this.position=new t,this.rotation=0,this.velocity=new t,this.angularVelocity=0,this.force=new t,this.torque=0,this.width=new t,this.friction=.2,this.mass=Number.MAX_VALUE,this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0,this.id=0,this.set(s,e)}set(t,s){return this.width=t,this.mass=s,s<Number.MAX_VALUE?(this.invMass=1/s,this.I=s*(t.x*t.x+t.y*t.y)/12,this.invI=1/this.I):(this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0),this}addForce(t){return this.force.add(t),this}}class e{constructor(t=0,s=0,e=0,i=0){this.a=t,this.c=s,this.b=e,this.d=i,window.mat22Total++}set(t){const s=Math.cos(t),e=Math.sin(t);return this.a=s,this.c=e,this.b=-e,this.d=s,this}setFromVec2(t,s){return this.a=t.x,this.c=t.y,this.b=s.x,this.d=s.y,this}get col1(){return new t(this.a,this.c)}get col2(){return new t(this.b,this.d)}static add(t,s){return new e(t.a+s.a,t.c+s.c,t.b+s.b,t.d+s.d)}static mulMV(s,e){return new t(s.a*e.x+s.b*e.y,s.c*e.x+s.d*e.y)}static mulMM(t,s){const i=t.a*s.a+t.c*s.c,n=t.b*s.a+t.d*s.c,o=t.a*s.b+t.c*s.d,a=t.b*s.b+t.d*s.d;return new e(i,n,o,a)}static abs(t){return new e(Math.abs(t.a),Math.abs(t.c),Math.abs(t.b),Math.abs(t.d))}static transpose(t){return new e(t.a,t.b,t.c,t.d)}static invert(t){const s=t.a,i=t.c,n=t.b,o=t.d;let a=1/(s*o-n*i);return new e(a*o,a*-n,a*-i,a*s)}}function i(t,s,e){return Math.max(s,Math.min(t,e))}var n,o;!function(t){t[t.FACE_A_X=0]="FACE_A_X",t[t.FACE_A_Y=1]="FACE_A_Y",t[t.FACE_B_X=2]="FACE_B_X",t[t.FACE_B_Y=3]="FACE_B_Y"}(n||(n={})),function(t){t[t.NO_EDGE=0]="NO_EDGE",t[t.EDGE1=1]="EDGE1",t[t.EDGE2=2]="EDGE2",t[t.EDGE3=3]="EDGE3",t[t.EDGE4=4]="EDGE4"}(o||(o={}));class a{constructor(){this.inEdge1=o.NO_EDGE,this.outEdge1=o.NO_EDGE,this.inEdge2=o.NO_EDGE,this.outEdge2=o.NO_EDGE}}class r{constructor(){this.e=new a,this.value=0}flip(){const t=this.e,s=t.inEdge1,e=t.outEdge1;t.inEdge1=t.inEdge2,t.inEdge2=s,t.outEdge1=t.outEdge2,t.outEdge2=e}}class l{constructor(){this.v=new t,this.fp=new r}}function c(s,i,n,a,r){let c=e.transpose(a),d=t.neg(e.mulMV(c,r)),h=t.abs(d);const u=new l,y=new l;h.x>h.y?Math.sign(d.x)>0?(u.v.set(i.x,-i.y),u.fp.e.inEdge2=o.EDGE3,u.fp.e.outEdge2=o.EDGE4,y.v.set(i.x,i.y),y.fp.e.inEdge2=o.EDGE4,y.fp.e.outEdge2=o.EDGE1):(u.v.set(-i.x,i.y),u.fp.e.inEdge2=o.EDGE1,u.fp.e.outEdge2=o.EDGE2,y.v.set(-i.x,-i.y),y.fp.e.inEdge2=o.EDGE2,y.fp.e.outEdge2=o.EDGE3):Math.sign(d.y)>0?(u.v.set(i.x,i.y),u.fp.e.inEdge2=o.EDGE4,u.fp.e.outEdge2=o.EDGE1,y.v.set(-i.x,i.y),y.fp.e.inEdge2=o.EDGE1,y.fp.e.outEdge2=o.EDGE2):(u.v.set(-i.x,-i.y),u.fp.e.inEdge2=o.EDGE2,u.fp.e.outEdge2=o.EDGE3,y.v.set(i.x,-i.y),y.fp.e.inEdge2=o.EDGE3,y.fp.e.outEdge2=o.EDGE4),u.v=t.add(n,e.mulMV(a,u.v)),y.v=t.add(n,e.mulMV(a,y.v)),s[0]=u,s[1]=y}class d{constructor(){this.position=new t,this.normal=new t,this.r1=new t,this.r2=new t,this.separation=0,this.Pn=0,this.Pt=0,this.Pnb=0,this.massNormal=0,this.massTangent=0,this.bias=0,this.feature=new r}}function h(s,e,i,n,a){let r=0,c=t.dot(i,e[0].v)-n,d=t.dot(i,e[1].v)-n;if(c<=0&&(s[r]=e[0],r++),d<=0&&(s[r]=e[1],r++),c*d<0){let i=c/(c-d);s[r]=new l,s[r].v=t.add(e[0].v,t.mulSV(i,t.sub(e[1].v,e[0].v))),c>0?(s[r].fp=e[0].fp,s[r].fp.e.inEdge1=a,s[r].fp.e.inEdge2=o.NO_EDGE):(s[r].fp=e[1].fp,s[r].fp.e.outEdge1=a,s[r].fp.e.outEdge2=o.NO_EDGE),r++}return r}class u{constructor(s,i,a){this.world=s,i.id<a.id?(this.body1=i,this.body2=a):(this.body1=a,this.body2=i),this.contacts=[],this.numContacts=function(s,i,a){let r=t.mulSV(.5,i.width),l=t.mulSV(.5,a.width),u=i.position,y=a.position,E=(new e).set(i.rotation),m=(new e).set(a.rotation),b=e.transpose(E),v=e.transpose(m),w=t.sub(y,u),V=e.mulMV(b,w),p=e.mulMV(v,w),g=e.mulMM(b,m),f=e.abs(g),x=e.transpose(f),M=t.sub(t.sub(t.abs(V),r),e.mulMV(f,l));if(M.x>0||M.y>0)return 0;let S=t.sub(t.sub(t.abs(p),e.mulMV(x,r)),l);if(S.x>0||S.y>0)return 0;let _,A,I=n.FACE_A_X,D=M.x,G=V.x>0?E.col1:t.neg(E.col1);M.y>.95*D+.01*r.y&&(I=n.FACE_A_Y,D=M.y,G=V.y>0?E.col2:t.neg(E.col2)),S.x>.95*D+.01*l.x&&(I=n.FACE_B_X,D=S.x,G=p.x>0?m.col1:t.neg(m.col1)),S.y>.95*D+.01*l.y&&(I=n.FACE_B_Y,D=S.y,G=p.y>0?m.col2:t.neg(m.col2));let P,C,B,F,T,N,X=[];switch(I){case n.FACE_A_X:_=G,P=t.dot(u,_)+r.x,A=E.col2,N=t.dot(u,A),C=-N+r.y,B=N+r.y,F=o.EDGE3,T=o.EDGE1,c(X,l,y,m,_);break;case n.FACE_A_Y:_=G,P=t.dot(u,_)+r.y,A=E.col1,N=t.dot(u,A),C=-N+r.x,B=N+r.x,F=o.EDGE2,T=o.EDGE4,c(X,l,y,m,_);break;case n.FACE_B_X:_=t.neg(G),P=t.dot(y,_)+l.x,A=m.col2,N=t.dot(y,A),C=-N+l.y,B=N+l.y,F=o.EDGE3,T=o.EDGE1,c(X,r,u,E,_);break;case n.FACE_B_Y:_=t.neg(G),P=t.dot(y,_)+l.y,A=m.col1,N=t.dot(y,A),C=-N+l.x,B=N+l.x,F=o.EDGE2,T=o.EDGE4,c(X,r,u,E,_)}let k=[],Y=[],O=h(k,X,t.neg(A),C,F);if(O<2)return 0;if(O=h(Y,k,A,B,T),O<2)return 0;let L=0;for(let e=0;e<2;e++){let i=t.dot(_,Y[e].v)-P;i<=0&&(s[L]=new d,s[L].separation=i,s[L].normal=G,s[L].position=t.sub(Y[e].v,t.mulSV(i,_)),s[L].feature=Y[e].fp,I!==n.FACE_B_X&&I!==n.FACE_B_Y||s[L].feature.flip(),L++)}return L}(this.contacts,this.body1,this.body2),this.friction=Math.sqrt(this.body1.friction*this.body2.friction)}update(t,s){let e=[],i=this.contacts,n=this.numContacts,o=this.world.warmStarting;for(let a=0;a<s;a++){let s=t[a],r=-1;for(let t=0;t<n;t++){let e=i[t];if(s.feature.value===e.feature.value){r=t;break}}if(r>-1){let t=i[r];o?(s.Pn=t.Pn,s.Pt=t.Pt,s.Pnb=t.Pnb):(s.Pn=0,s.Pt=0,s.Pnb=0),e[a]=s}else e[a]=t[a]}this.contacts=e,this.numContacts=s}preStep(s){let e=this.contacts,i=this.numContacts,n=this.world.positionCorrection?.2:0,o=this.body1,a=this.body2,r=this.world.accumulateImpulses;for(let l=0;l<i;l++){let i=e[l],c=t.sub(i.position,o.position),d=t.sub(i.position,a.position),h=t.dot(c,i.normal),u=t.dot(d,i.normal),y=o.invMass+a.invMass;y+=o.invI*(t.dot(c,c)-h*h)+a.invI*(t.dot(d,d)-u*u),i.massNormal=1/y;let E=t.crossVS(i.normal,1),m=t.dot(c,E),b=t.dot(d,E),v=o.invMass+a.invMass;if(v+=o.invI*(t.dot(c,c)-m*m)+a.invI*(t.dot(d,d)-b*b),i.massTangent=1/v,i.bias=-n*s*Math.min(0,i.separation+.01),r){let s=t.add(t.mulSV(i.Pn,i.normal),t.mulSV(i.Pt,E));o.velocity.sub(t.mulSV(o.invMass,s)),o.angularVelocity-=o.invI*t.crossVV(c,s),a.velocity.add(t.mulSV(a.invMass,s)),a.angularVelocity+=a.invI*t.crossVV(d,s)}}}applyImpulse(){let s=this.contacts,e=this.numContacts,n=this.body1,o=this.body2,a=this.world.accumulateImpulses;for(let r=0;r<e;r++){let e=s[r];e.r1=t.sub(e.position,n.position),e.r2=t.sub(e.position,o.position);let l=t.sub(t.sub(t.add(o.velocity,t.crossSV(o.angularVelocity,e.r2)),n.velocity),t.crossSV(n.angularVelocity,e.r1)),c=t.dot(l,e.normal),d=e.massNormal*(-c+e.bias);if(a){let t=e.Pn;e.Pn=Math.max(t+d,0),d=e.Pn-t}else d=Math.max(d,0);let h=t.mulSV(d,e.normal);n.velocity.sub(t.mulSV(n.invMass,h)),n.angularVelocity-=n.invI*t.crossVV(e.r1,h),o.velocity.add(t.mulSV(o.invMass,h)),o.angularVelocity+=o.invI*t.crossVV(e.r2,h),l=t.sub(t.sub(t.add(o.velocity,t.crossSV(o.angularVelocity,e.r2)),n.velocity),t.crossSV(n.angularVelocity,e.r1));let u=t.crossVS(e.normal,1),y=t.dot(l,u),E=e.massTangent*-y;if(a){let t=this.friction*e.Pn,s=e.Pt;e.Pt=i(s+E,-t,t),E=e.Pt-s}else{let t=this.friction*d;E=i(E,-t,t)}let m=t.mulSV(E,u);n.velocity.sub(t.mulSV(n.invMass,m)),n.angularVelocity-=n.invI*t.crossVV(e.r1,m),o.velocity.add(t.mulSV(o.invMass,m)),o.angularVelocity+=o.invI*t.crossVV(e.r2,m)}}}class y{constructor(t,s){this.bodyA=t,this.bodyB=s,this.value=t.id+":"+s.id}}class E{constructor(t,s){this.first=t,this.second=s}}window.vec2Total=0,window.mat22Total=0;let m,b=new class{constructor(s=new t(0,9.807),e=10){this.bodyIdSeed=0,this.bodies=[],this.joints=[],this.arbiters=[],this.gravity=new t,this.iterations=10,this.accumulateImpulses=!0,this.warmStarting=!0,this.positionCorrection=!0,this.gravity.x=s.x,this.gravity.y=s.y,this.iterations=e}addBody(t){return this.bodyIdSeed++,t.id=this.bodyIdSeed,this.bodies.push(t),this}addJoint(t){return this.joints.push(t),this}clear(){return this.bodies=[],this.joints=[],this.arbiters=[],this}broadPhase(){let t=this.bodies,s=t.length,e=this.arbiters;for(let i=0;i<s-1;i++){let n=t[i];for(let o=i+1;o<s;o++){let s=t[o];if(0===n.invMass&&0===s.invMass)continue;let i=new u(this,n,s),a=new y(n,s),r=-1;for(let t=0;t<e.length;t++)if(e[t].first.value===a.value){r=t;break}i.numContacts>0?-1===r?e.push(new E(a,i)):e[r].second.update(i.contacts,i.numContacts):0===i.numContacts&&r>-1&&e.splice(r,1)}}}step(s){let e=s>0?1/s:0;this.broadPhase();const i=this.bodies,n=this.gravity;for(let e=0;e<i.length;e++){let o=i[e];0!==o.invMass&&(o.velocity.add(t.mulSV(s,t.add(n,t.mulSV(o.invMass,o.force)))),o.angularVelocity+=s*o.invI*o.torque)}const o=this.arbiters,a=this.joints;for(let t=0;t<o.length;t++)o[t].second.preStep(e);for(let t=0;t<a.length;t++)a[t].preStep(e);for(let t=0;t<this.iterations;t++){for(let t=0;t<o.length;t++)o[t].second.applyImpulse();for(let t=0;t<a.length;t++)a[t].applyImpulse()}for(let e=0;e<i.length;e++){let n=i[e];n.position.add(t.mulSV(s,n.velocity)),n.rotation+=s*n.angularVelocity,n.force.set(0,0),n.torque=0}}}(new t(0,40),10),v=new s(new t(2e3,80),Number.MAX_VALUE);v.position.set(500,500),b.addBody(v);let w=new t(300,-150);for(let e=0;e<10;e++)for(let i=0;i<10;i++)m=new s(new t(12,12),5),m.position.set(w.x+16*e,w.y+16*i),m.velocity.y=-50+i,b.addBody(m);let V=new s(new t(25,25),Number.MAX_VALUE);V.position.set(530,50),b.addBody(V);let p=new s(new t(50,50),900);p.position.set(685,40),b.addBody(p);let g=new class{constructor(){this.M=new e,this.localAnchor1=new t,this.localAnchor2=new t,this.r1=new t,this.r2=new t,this.bias=new t,this.P=new t,this.biasFactor=.2,this.softness=0}set(s,i,n,o){this.world=s,this.body1=i,this.body2=n;let a=(new e).set(i.rotation),r=(new e).set(n.rotation),l=e.transpose(a),c=e.transpose(r);this.localAnchor1=e.mulMV(l,t.sub(o,i.position)),this.localAnchor2=e.mulMV(c,t.sub(o,n.position))}preStep(s){const i=this.body1,n=this.body2;let o=(new e).set(i.rotation),a=(new e).set(n.rotation),r=e.mulMV(o,this.localAnchor1),l=e.mulMV(a,this.localAnchor2),c=new e(i.invMass+n.invMass,0,0,i.invMass+n.invMass),d=new e(i.invI*r.y*r.y,-i.invI*r.x*r.y,-i.invI*r.x*r.y,i.invI*r.x*r.x),h=new e(n.invI*l.y*l.y,-n.invI*l.x*l.y,-n.invI*l.x*l.y,n.invI*l.x*l.x),u=e.add(e.add(c,d),h);u.a+=this.softness,u.d+=this.softness,this.M=e.invert(u);let y=t.add(i.position,r),E=t.add(n.position,l),m=t.sub(E,y);this.world.positionCorrection?this.bias=t.mulSV(-this.biasFactor,t.mulSV(s,m)):this.bias.set(0,0),this.world.warmStarting?(i.velocity.sub(t.mulSV(i.invMass,this.P)),i.angularVelocity-=i.invI*t.crossVV(r,this.P),n.velocity.add(t.mulSV(n.invMass,this.P)),n.angularVelocity+=n.invI*t.crossVV(l,this.P)):this.P.set(0,0),this.r1=r,this.r2=l}applyImpulse(){const s=this.body1,i=this.body2,n=this.r1,o=this.r2;let a=t.sub(t.sub(t.add(i.velocity,t.crossSV(i.angularVelocity,o)),s.velocity),t.crossSV(s.angularVelocity,n)),r=new t;r=e.mulMV(this.M,t.sub(t.sub(this.bias,a),t.mulSV(this.softness,this.P))),s.velocity.sub(t.mulSV(s.invMass,r)),s.angularVelocity-=s.invI*t.crossVV(n,r),i.velocity.add(t.mulSV(i.invMass,r)),i.angularVelocity+=i.invI*t.crossVV(o,r),this.P.add(r)}};g.set(b,V,p,V.position),b.addJoint(g);let f=new class{constructor(t){this.canvas=t,this.context=t.getContext("2d")}render(t){const s=this.context,e=t.bodies,i=t.joints,n=t.arbiters;s.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<e.length;t++)this.renderBody(e[t],s);for(let t=0;t<n.length;t++){let e=n[t].second;for(let t=0;t<e.contacts.length;t++)this.renderContact(e.contacts[t],s)}for(let t=0;t<i.length;t++)this.renderJoint(i[t],s)}renderBody(s,i){let n=(new e).set(s.rotation),o=s.position,a=t.mulSV(.5,s.width),r=t.add(o,e.mulMV(n,new t(-a.x,-a.y))),l=t.add(o,e.mulMV(n,new t(a.x,-a.y))),c=t.add(o,e.mulMV(n,new t(a.x,a.y))),d=t.add(o,e.mulMV(n,new t(-a.x,a.y))),h=t.add(o,e.mulMV(n,new t(a.x,0)));i.strokeStyle="black",i.lineWidth=.5,i.beginPath(),i.arc(s.position.x,s.position.y,2,0,2*Math.PI),i.stroke(),i.beginPath(),i.moveTo(r.x,r.y),i.lineTo(l.x,l.y),i.lineTo(c.x,c.y),i.lineTo(d.x,d.y),i.lineTo(r.x,r.y),i.stroke(),i.beginPath(),i.moveTo(o.x,o.y),i.lineTo(h.x,h.y),i.stroke()}renderContact(t,s){s.strokeStyle="red",s.lineWidth=.5,s.beginPath(),s.arc(t.position.x,t.position.y,2,0,2*Math.PI),s.stroke()}renderJoint(s,i){let n=s.body1,o=s.body2,a=(new e).set(n.rotation),r=(new e).set(o.rotation),l=n.position,c=t.add(l,e.mulMV(a,s.localAnchor1)),d=o.position,h=t.add(d,e.mulMV(r,s.localAnchor2));i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(c.x,c.y),i.lineTo(d.x,d.y),i.lineTo(h.x,h.y),i.stroke()}}(document.getElementById("demo")),x=!0,M=0,S=document.getElementById("frame"),_=document.getElementById("vec2"),A=document.getElementById("mat22");document.getElementById("pause").addEventListener("click",()=>{x=!x}),function t(){window.vec2Total=0,window.mat22Total=0,x||(b.step(1/30),f.render(b),M++,S.value=M.toString(),_.value=window.vec2Total.toString(),A.value=window.mat22Total.toString()),requestAnimationFrame(t)}()}();
