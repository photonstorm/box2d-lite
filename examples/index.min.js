!function(){"use strict";class t{constructor(t=0,s=0){this.x=t,this.y=s,window.vec2Total++}set(t=0,s=0){this.x=t,this.y=s}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}mul(t){this.x*=t,this.y*=t}static add(s,i){return new t(s.x+i.x,s.y+i.y)}static sub(s,i){return new t(s.x-i.x,s.y-i.y)}static mulVV(s,i){return new t(s.x*i.x,s.y*i.y)}static mulSV(s,i){return new t(s*i.x,s*i.y)}static abs(s){return new t(Math.abs(s.x),Math.abs(s.y))}static neg(s){return new t(-s.x,-s.y)}static dot(t,s){return t.x*s.x+t.y*s.y}static dotXYV(t,s,i){return t*i.x+s*i.y}static dotXY(t,s,i,e){return t*i+s*e}static crossVV(t,s){return t.x*s.y-t.y*s.x}static crossVXY(t,s,i){return t.x*i-t.y*s}static crossXY(t,s,i,e){return t*e-s*i}static crossVS(s,i){return new t(i*s.y,-i*s.x)}static crossSV(s,i){return new t(-s*i.y,s*i.x)}}class s{constructor(s,i){this.position=new t,this.rotation=0,this.velocity=new t,this.angularVelocity=0,this.force=new t,this.torque=0,this.width=new t,this.friction=.2,this.mass=Number.MAX_VALUE,this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0,this.id=0,this.set(s,i)}set(t,s){return this.width=t,this.mass=s,s<Number.MAX_VALUE?(this.invMass=1/s,this.I=s*(t.x*t.x+t.y*t.y)/12,this.invI=1/this.I):(this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0),this}addForce(t){return this.force.add(t),this}}class i{constructor(t=0,s=0,i=0,e=0){this.a=t,this.c=s,this.b=i,this.d=e,window.mat22Total++}set(t){const s=Math.cos(t),i=Math.sin(t);return this.a=s,this.c=i,this.b=-i,this.d=s,this}setFromVec2(t,s){return this.a=t.x,this.c=t.y,this.b=s.x,this.d=s.y,this}static add(t,s){return new i(t.a+s.a,t.c+s.c,t.b+s.b,t.d+s.d)}static mulMV(s,i){return new t(s.a*i.x+s.b*i.y,s.c*i.x+s.d*i.y)}static mulMM(t,s){const e=t.a*s.a+t.c*s.c,n=t.b*s.a+t.d*s.c,o=t.a*s.b+t.c*s.d,a=t.b*s.b+t.d*s.d;return new i(e,n,o,a)}static abs(t){return new i(Math.abs(t.a),Math.abs(t.c),Math.abs(t.b),Math.abs(t.d))}static transpose(t){return new i(t.a,t.b,t.c,t.d)}static invert(t){const s=t.a,e=t.c,n=t.b,o=t.d;let a=1/(s*o-n*e);return new i(a*o,a*-n,a*-e,a*s)}}function e(t,s,i){return Math.max(s,Math.min(t,i))}var n,o;!function(t){t[t.FACE_A_X=0]="FACE_A_X",t[t.FACE_A_Y=1]="FACE_A_Y",t[t.FACE_B_X=2]="FACE_B_X",t[t.FACE_B_Y=3]="FACE_B_Y"}(n||(n={})),function(t){t[t.NO_EDGE=0]="NO_EDGE",t[t.EDGE1=1]="EDGE1",t[t.EDGE2=2]="EDGE2",t[t.EDGE3=3]="EDGE3",t[t.EDGE4=4]="EDGE4"}(o||(o={}));class a{constructor(){this.inEdge1=o.NO_EDGE,this.outEdge1=o.NO_EDGE,this.inEdge2=o.NO_EDGE,this.outEdge2=o.NO_EDGE}}class r{constructor(){this.e=new a,this.value=0}flip(){const t=this.e,s=t.inEdge1,i=t.outEdge1;t.inEdge1=t.inEdge2,t.inEdge2=s,t.outEdge1=t.outEdge2,t.outEdge2=i}}class l{constructor(){this.v=new t,this.fp=new r}}function h(t,s,i,e,n,a){const r=-(e.a*n+e.c*a),h=-(e.b*n+e.d*a),c=Math.abs(r),d=Math.abs(h),u=new l,y=new l;c>d?Math.sign(r)>0?(u.v.set(s.x,-s.y),u.fp.e.inEdge2=o.EDGE3,u.fp.e.outEdge2=o.EDGE4,y.v.set(s.x,s.y),y.fp.e.inEdge2=o.EDGE4,y.fp.e.outEdge2=o.EDGE1):(u.v.set(-s.x,s.y),u.fp.e.inEdge2=o.EDGE1,u.fp.e.outEdge2=o.EDGE2,y.v.set(-s.x,-s.y),y.fp.e.inEdge2=o.EDGE2,y.fp.e.outEdge2=o.EDGE3):Math.sign(h)>0?(u.v.set(s.x,s.y),u.fp.e.inEdge2=o.EDGE4,u.fp.e.outEdge2=o.EDGE1,y.v.set(-s.x,s.y),y.fp.e.inEdge2=o.EDGE1,y.fp.e.outEdge2=o.EDGE2):(u.v.set(-s.x,-s.y),u.fp.e.inEdge2=o.EDGE2,u.fp.e.outEdge2=o.EDGE3,y.v.set(s.x,-s.y),y.fp.e.inEdge2=o.EDGE3,y.fp.e.outEdge2=o.EDGE4);const v=u.v,E=y.v;let w=i.x+(e.a*v.x+e.b*v.y),b=i.y+(e.c*v.x+e.d*v.y);v.set(w,b),w=i.x+(e.a*E.x+e.b*E.y),b=i.y+(e.c*E.x+e.d*E.y),E.set(w,b),t[0]=u,t[1]=y}class c{constructor(t,s,i,e,n,o){this.positionX=e,this.positionY=n,this.normalX=s,this.normalY=i,this.r1X=0,this.r1Y=0,this.r2X=0,this.r2Y=0,this.separation=t,this.Pn=0,this.Pt=0,this.Pnb=0,this.massNormal=0,this.massTangent=0,this.bias=0,this.feature=o}}function d(s,i,e,n,a,r){let h=0,c=t.dotXYV(e,n,i[0].v)-a,d=t.dotXYV(e,n,i[1].v)-a;if(c<=0&&(s[h]=i[0],h++),d<=0&&(s[h]=i[1],h++),c*d<0){let t=c/(c-d),e=new l;e.v.set(i[0].v.x+t*(i[1].v.x-i[0].v.x),i[0].v.y+t*(i[1].v.y-i[0].v.y)),c>0?(e.fp=i[0].fp,e.fp.e.inEdge1=r,e.fp.e.inEdge2=o.NO_EDGE):(e.fp=i[1].fp,e.fp.e.outEdge1=r,e.fp.e.outEdge2=o.NO_EDGE),s[h]=e,h++}return h}function u(s,e,a){let r=t.mulSV(.5,e.width),l=t.mulSV(.5,a.width),u=e.position,y=a.position,v=(new i).set(e.rotation),E=(new i).set(a.rotation),w=i.transpose(v),b=i.transpose(E),m=t.sub(y,u),p=i.mulMV(w,m),x=i.mulMV(b,m),M=i.mulMM(w,E),g=i.abs(M),f=i.transpose(g),_=t.sub(t.sub(t.abs(p),r),i.mulMV(g,l));if(_.x>0||_.y>0)return 0;let V=t.sub(t.sub(t.abs(x),i.mulMV(f,r)),l);if(V.x>0||V.y>0)return 0;let X=n.FACE_A_X,Y=_.x,A=0,I=0;p.x>0?(A=v.a,I=v.c):(A=-v.a,I=-v.c);_.y>.95*Y+.01*r.y&&(X=n.FACE_A_Y,Y=_.y,p.y>0?(A=v.b,I=v.d):(A=-v.b,I=-v.d)),V.x>.95*Y+.01*l.x&&(X=n.FACE_B_X,Y=V.x,x.x>0?(A=E.a,I=E.c):(A=-E.a,I=-E.c)),V.y>.95*Y+.01*l.y&&(X=n.FACE_B_Y,Y=V.y,x.y>0?(A=E.b,I=E.d):(A=-E.b,I=-E.d));let D=A,G=I,P=[],C=null;if(X===n.FACE_A_X?C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,s)+a.x,v=e.b,E=e.d,w=t.dotXYV(v,E,s),b=-w+a.y,m=w+a.y,p=[];h(p,r,i,n,l,c);let x=[],M=d(x,p,-v,-E,b,o.EDGE3);return M<2?null:(M=d(u,x,v,E,m,o.EDGE1),M<2?null:y)}(u,y,v,E,r,l,D,G,P):X===n.FACE_A_Y?C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,s)+a.y,v=e.a,E=e.c,w=t.dotXYV(v,E,s),b=-w+a.x,m=w+a.x,p=[];h(p,r,i,n,l,c);let x=[],M=d(x,p,-v,-E,b,o.EDGE2);return M<2?null:(M=d(u,x,v,E,m,o.EDGE4),M<2?null:y)}(u,y,v,E,r,l,D,G,P):X===n.FACE_B_X?(D=-A,G=-I,C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,i)+r.x,v=n.b,E=n.d,w=t.dotXYV(v,E,i),b=-w+r.y,m=w+r.y,p=[];h(p,a,s,e,l,c);let x=[],M=d(x,p,-v,-E,b,o.EDGE3);return M<2?null:(M=d(u,x,v,E,m,o.EDGE1),M<2?null:y)}(u,y,v,E,r,l,D,G,P)):X===n.FACE_B_Y&&(D=-A,G=-I,C=function(s,i,e,n,a,r,l,c,u){let y=t.dotXYV(l,c,i)+r.y,v=n.a,E=n.c,w=t.dotXYV(v,E,i),b=-w+r.x,m=w+r.x,p=[];h(p,a,s,e,l,c);let x=[],M=d(x,p,-v,-E,b,o.EDGE2);return M<2?null:(M=d(u,x,v,E,m,o.EDGE4),M<2?null:y)}(u,y,v,E,r,l,D,G,P)),null===C)return 0;let S=0;for(let i=0;i<2;i++){let e=t.dotXYV(D,G,P[i].v)-C;e<=0&&(s[S]=new c(e,A,I,P[i].v.x-e*D,P[i].v.y-e*G,P[i].fp),X!==n.FACE_B_X&&X!==n.FACE_B_Y||s[S].feature.flip(),S++)}return S}class y{constructor(t,s,i){this.world=t,s.id<i.id?(this.body1=s,this.body2=i):(this.body1=i,this.body2=s),this.contacts=[],this.numContacts=u(this.contacts,this.body1,this.body2),this.friction=Math.sqrt(this.body1.friction*this.body2.friction)}update(t,s){let i=[],e=this.contacts,n=this.numContacts,o=this.world.warmStarting;for(let a=0;a<s;a++){let s=t[a],r=-1;for(let t=0;t<n;t++){let i=e[t];if(s.feature.value===i.feature.value){r=t;break}}if(r>-1){let t=e[r];o?(s.Pn=t.Pn,s.Pt=t.Pt,s.Pnb=t.Pnb):(s.Pn=0,s.Pt=0,s.Pnb=0),i[a]=s}else i[a]=t[a]}this.contacts=i,this.numContacts=s}preStep(s){let i=this.contacts,e=this.numContacts,n=this.world.positionCorrection?.2:0,o=this.body1,a=this.body2,r=this.world.accumulateImpulses;for(let l=0;l<e;l++){let e=i[l],h=e.positionX-o.position.x,c=e.positionY-o.position.y,d=e.positionX-a.position.x,u=e.positionY-a.position.y,y=t.dotXY(h,c,e.normalX,e.normalY),v=t.dotXY(d,u,e.normalX,e.normalY),E=o.invMass+a.invMass;E+=o.invI*(t.dotXY(h,c,h,c)-y*y)+a.invI*(t.dotXY(d,u,d,u)-v*v),e.massNormal=1/E;let w=e.normalY,b=-1*e.normalX,m=t.dotXY(h,c,w,b),p=t.dotXY(d,u,w,b),x=o.invMass+a.invMass;if(x+=o.invI*(t.dotXY(h,c,h,c)-m*m)+a.invI*(t.dotXY(d,u,d,u)-p*p),e.massTangent=1/x,e.bias=-n*s*Math.min(0,e.separation+.01),r){let t=e.Pn*e.normalX+e.Pt*w,s=e.Pn*e.normalY+e.Pt*b;o.velocity.x-=o.invMass*t,o.velocity.y-=o.invMass*s,o.angularVelocity-=o.invI*(h*s-c*t),a.velocity.x+=a.invMass*t,a.velocity.y+=a.invMass*s,a.angularVelocity+=a.invI*(d*s-u*t)}}}applyImpulse(){let s=this.contacts,i=this.numContacts,n=this.body1,o=this.body2,a=this.world.accumulateImpulses;for(let r=0;r<i;r++){let i=s[r];i.r1X=i.positionX-n.position.x,i.r1Y=i.positionY-n.position.y,i.r2X=i.positionX-o.position.x,i.r2Y=i.positionY-o.position.y;let l=o.velocity.x+-o.angularVelocity*i.r2Y-n.velocity.x,h=o.velocity.y+o.angularVelocity*i.r2X-n.velocity.y,c=l- -n.angularVelocity*i.r1Y,d=h-n.angularVelocity*i.r1X,u=t.dotXY(c,d,i.normalX,i.normalY),y=i.massNormal*(-u+i.bias);if(a){let t=i.Pn;i.Pn=Math.max(t+y,0),y=i.Pn-t}else y=Math.max(y,0);let v=y*i.normalX,E=y*i.normalY;n.velocity.x-=n.invMass*v,n.velocity.y-=n.invMass*E,n.angularVelocity-=n.invI*t.crossXY(i.r1X,i.r1Y,v,E),o.velocity.x+=o.invMass*v,o.velocity.y+=o.invMass*E,o.angularVelocity+=o.invI*t.crossXY(i.r2X,i.r2Y,v,E);let w=i.normalY,b=-1*i.normalX,m=t.dotXY(c,d,w,b),p=i.massTangent*-m;if(a){let t=this.friction*i.Pn,s=i.Pt;i.Pt=e(s+p,-t,t),p=i.Pt-s}else{let t=this.friction*y;p=e(p,-t,t)}v=p*w,E=p*b,n.velocity.x-=n.invMass*v,n.velocity.y-=n.invMass*E,n.angularVelocity-=n.invI*t.crossXY(i.r1X,i.r1Y,v,E),o.velocity.x+=o.invMass*v,o.velocity.y+=o.invMass*E,o.angularVelocity+=o.invI*t.crossXY(i.r2X,i.r2X,v,E)}}}class v{constructor(t,s){this.bodyA=t,this.bodyB=s,this.value=t.id+":"+s.id}}class E{constructor(t,s){this.first=t,this.second=s}}window.vec2Total=0,window.mat22Total=0;let w,b=new class{constructor(s=new t(0,9.807),i=10){this.bodyIdSeed=0,this.bodies=[],this.joints=[],this.arbiters=[],this.gravity=new t,this.iterations=10,this.accumulateImpulses=!0,this.warmStarting=!0,this.positionCorrection=!0,this.gravity.x=s.x,this.gravity.y=s.y,this.iterations=i}addBody(t){return this.bodyIdSeed++,t.id=this.bodyIdSeed,this.bodies.push(t),this}addJoint(t){return this.joints.push(t),this}clear(){return this.bodies=[],this.joints=[],this.arbiters=[],this}broadPhase(){let t=this.bodies,s=t.length,i=this.arbiters;for(let e=0;e<s-1;e++){let n=t[e];for(let o=e+1;o<s;o++){let s=t[o];if(0===n.invMass&&0===s.invMass)continue;let e=new y(this,n,s),a=new v(n,s),r=-1;for(let t=0;t<i.length;t++)if(i[t].first.value===a.value){r=t;break}e.numContacts>0?-1===r?i.push(new E(a,e)):i[r].second.update(e.contacts,e.numContacts):0===e.numContacts&&r>-1&&i.splice(r,1)}}}step(s){let i=s>0?1/s:0;this.broadPhase(),window.step1=window.vec2Total;const e=this.bodies,n=this.gravity;for(let i=0;i<e.length;i++){let o=e[i];0!==o.invMass&&(o.velocity.add(t.mulSV(s,t.add(n,t.mulSV(o.invMass,o.force)))),o.angularVelocity+=s*o.invI*o.torque)}window.step2=window.vec2Total;const o=this.arbiters,a=this.joints;for(let t=0;t<o.length;t++)o[t].second.preStep(i);window.step3=window.vec2Total;for(let t=0;t<a.length;t++)a[t].preStep(i);window.step4=window.vec2Total;for(let t=0;t<this.iterations;t++){for(let t=0;t<o.length;t++)o[t].second.applyImpulse();for(let t=0;t<a.length;t++)a[t].applyImpulse()}window.step5=window.vec2Total;for(let i=0;i<e.length;i++){let n=e[i];n.position.add(t.mulSV(s,n.velocity)),n.rotation+=s*n.angularVelocity,n.force.set(0,0),n.torque=0}window.step6=window.vec2Total}}(new t(0,40),10),m=new s(new t(2e3,80),Number.MAX_VALUE);m.position.set(500,500),b.addBody(m);let p=new t(300,-150);for(let i=0;i<10;i++)for(let e=0;e<10;e++)w=new s(new t(12,12),5),w.position.set(p.x+16*i,p.y+16*e),w.velocity.y=-50+e,b.addBody(w);let x=new s(new t(25,25),Number.MAX_VALUE);x.position.set(530,50),b.addBody(x);let M=new s(new t(50,50),900);M.position.set(685,40),b.addBody(M);let g=new class{constructor(){this.M=new i,this.localAnchor1=new t,this.localAnchor2=new t,this.r1=new t,this.r2=new t,this.bias=new t,this.P=new t,this.biasFactor=.2,this.softness=0}set(s,e,n,o){this.world=s,this.body1=e,this.body2=n;let a=(new i).set(e.rotation),r=(new i).set(n.rotation),l=i.transpose(a),h=i.transpose(r);this.localAnchor1=i.mulMV(l,t.sub(o,e.position)),this.localAnchor2=i.mulMV(h,t.sub(o,n.position))}preStep(s){const e=this.body1,n=this.body2;let o=(new i).set(e.rotation),a=(new i).set(n.rotation),r=i.mulMV(o,this.localAnchor1),l=i.mulMV(a,this.localAnchor2),h=new i(e.invMass+n.invMass,0,0,e.invMass+n.invMass),c=new i(e.invI*r.y*r.y,-e.invI*r.x*r.y,-e.invI*r.x*r.y,e.invI*r.x*r.x),d=new i(n.invI*l.y*l.y,-n.invI*l.x*l.y,-n.invI*l.x*l.y,n.invI*l.x*l.x),u=i.add(i.add(h,c),d);u.a+=this.softness,u.d+=this.softness,this.M=i.invert(u);let y=t.add(e.position,r),v=t.add(n.position,l),E=t.sub(v,y);this.world.positionCorrection?this.bias=t.mulSV(-this.biasFactor,t.mulSV(s,E)):this.bias.set(0,0),this.world.warmStarting?(e.velocity.sub(t.mulSV(e.invMass,this.P)),e.angularVelocity-=e.invI*t.crossVV(r,this.P),n.velocity.add(t.mulSV(n.invMass,this.P)),n.angularVelocity+=n.invI*t.crossVV(l,this.P)):this.P.set(0,0),this.r1=r,this.r2=l}applyImpulse(){const s=this.body1,e=this.body2,n=this.r1,o=this.r2;let a=t.sub(t.sub(t.add(e.velocity,t.crossSV(e.angularVelocity,o)),s.velocity),t.crossSV(s.angularVelocity,n)),r=new t;r=i.mulMV(this.M,t.sub(t.sub(this.bias,a),t.mulSV(this.softness,this.P))),s.velocity.sub(t.mulSV(s.invMass,r)),s.angularVelocity-=s.invI*t.crossVV(n,r),e.velocity.add(t.mulSV(e.invMass,r)),e.angularVelocity+=e.invI*t.crossVV(o,r),this.P.add(r)}};g.set(b,x,M,x.position),b.addJoint(g);let f=new class{constructor(s){this.canvas=s,this.context=s.getContext("2d"),this._M0=new i,this._M1=new i,this._v1=new t,this._v2=new t,this._v3=new t,this._v4=new t,this._orientation=new t}render(t){const s=this.context,i=t.bodies,e=t.joints,n=t.arbiters;s.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<i.length;t++)this.renderBody(i[t],s);for(let t=0;t<n.length;t++){let i=n[t].second;for(let t=0;t<i.contacts.length;t++)this.renderContact(i.contacts[t],s)}for(let t=0;t<e.length;t++)this.renderJoint(e[t],s)}renderBody(t,s){this._M0.set(t.rotation);let i=t.position,e=.5*t.width.x,n=.5*t.width.y;const o=this._v1,a=this._v2,r=this._v3,l=this._v4;o.set(i.x+(this._M0.a*-e+this._M0.b*-n),i.y+(this._M0.c*-e+this._M0.d*-n)),a.set(i.x+(this._M0.a*e+this._M0.b*-n),i.y+(this._M0.c*e+this._M0.d*-n)),r.set(i.x+(this._M0.a*e+this._M0.b*n),i.y+(this._M0.c*e+this._M0.d*n)),l.set(i.x+(this._M0.a*-e+this._M0.b*n),i.y+(this._M0.c*-e+this._M0.d*n));const h=this._orientation;h.set(i.x+this._M0.a*e,i.y+this._M0.c*e),s.strokeStyle="black",s.lineWidth=.5,s.beginPath(),s.arc(t.position.x,t.position.y,2,0,2*Math.PI),s.moveTo(o.x,o.y),s.lineTo(a.x,a.y),s.lineTo(r.x,r.y),s.lineTo(l.x,l.y),s.lineTo(o.x,o.y),s.moveTo(i.x,i.y),s.lineTo(h.x,h.y),s.stroke()}renderContact(t,s){s.strokeStyle="red",s.lineWidth=.5,s.beginPath(),s.arc(t.positionX,t.positionY,2,0,2*Math.PI),s.stroke()}renderJoint(t,s){let i=t.body1,e=t.body2;this._M0.set(i.rotation),this._M1.set(e.rotation);let n=i.position,o=e.position;const a=this._v1,r=this._v2;a.set(n.x+(this._M0.a*t.localAnchor1.x+this._M0.b*t.localAnchor1.y),n.y+(this._M0.c*t.localAnchor1.x+this._M0.d*t.localAnchor1.y)),r.set(o.x+(this._M1.a*t.localAnchor2.x+this._M1.b*t.localAnchor2.y),o.y+(this._M1.c*t.localAnchor2.x+this._M1.d*t.localAnchor2.y)),s.beginPath(),s.moveTo(n.x,n.y),s.lineTo(a.x,a.y),s.lineTo(o.x,o.y),s.lineTo(r.x,r.y),s.stroke()}}(document.getElementById("demo")),_=!0,V=0,X=document.getElementById("frame"),Y=document.getElementById("vec2"),A=document.getElementById("mat22"),I=document.getElementById("frame200"),D=document.getElementById("frame600");document.getElementById("pause").addEventListener("click",()=>{_=!_}),console.log("start-up: ",window.vec2Total,window.mat22Total),function t(){window.vec2Total=0,window.mat22Total=0,_||(b.step(1/30),f.render(b),X.value=V.toString(),Y.value=window.vec2Total.toString(),A.value=window.mat22Total.toString(),200===V?I.value="vec2: "+Y.value+" mat22: "+A.value+" arbiters: "+b.arbiters.length+" bodies: "+b.bodies.length:600===V&&(D.value="vec2: "+Y.value+" mat22: "+A.value+" arbiters: "+b.arbiters.length+" bodies: "+b.bodies.length),V++),requestAnimationFrame(t)}()}();
