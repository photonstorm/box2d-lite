!function(){"use strict";class t{constructor(t=0,s=0){this.x=t,this.y=s,window.vec2Total++}set(t=0,s=0){this.x=t,this.y=s}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}mul(t){this.x*=t,this.y*=t}static add(s,e){return new t(s.x+e.x,s.y+e.y)}static sub(s,e){return new t(s.x-e.x,s.y-e.y)}static mulVV(s,e){return new t(s.x*e.x,s.y*e.y)}static mulSV(s,e){return new t(s*e.x,s*e.y)}static abs(s){return new t(Math.abs(s.x),Math.abs(s.y))}static neg(s){return new t(-s.x,-s.y)}static dot(t,s){return t.x*s.x+t.y*s.y}static dotXYV(t,s,e){return t*e.x+s*e.y}static dotXY(t,s,e,i){return t*e+s*i}static crossVV(t,s){return t.x*s.y-t.y*s.x}static crossVS(s,e){return new t(e*s.y,-e*s.x)}static crossSV(s,e){return new t(-s*e.y,s*e.x)}}class s{constructor(s,e){this.position=new t,this.rotation=0,this.velocity=new t,this.angularVelocity=0,this.force=new t,this.torque=0,this.width=new t,this.friction=.2,this.mass=Number.MAX_VALUE,this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0,this.id=0,this.set(s,e)}set(t,s){return this.width=t,this.mass=s,s<Number.MAX_VALUE?(this.invMass=1/s,this.I=s*(t.x*t.x+t.y*t.y)/12,this.invI=1/this.I):(this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0),this}addForce(t){return this.force.add(t),this}}class e{constructor(t=0,s=0,e=0,i=0){this.a=t,this.c=s,this.b=e,this.d=i,window.mat22Total++}set(t){const s=Math.cos(t),e=Math.sin(t);return this.a=s,this.c=e,this.b=-e,this.d=s,this}setFromVec2(t,s){return this.a=t.x,this.c=t.y,this.b=s.x,this.d=s.y,this}get col1(){return new t(this.a,this.c)}get col2(){return new t(this.b,this.d)}static add(t,s){return new e(t.a+s.a,t.c+s.c,t.b+s.b,t.d+s.d)}static mulMV(s,e){return new t(s.a*e.x+s.b*e.y,s.c*e.x+s.d*e.y)}static mulMM(t,s){const i=t.a*s.a+t.c*s.c,n=t.b*s.a+t.d*s.c,o=t.a*s.b+t.c*s.d,a=t.b*s.b+t.d*s.d;return new e(i,n,o,a)}static abs(t){return new e(Math.abs(t.a),Math.abs(t.c),Math.abs(t.b),Math.abs(t.d))}static transpose(t){return new e(t.a,t.b,t.c,t.d)}static invert(t){const s=t.a,i=t.c,n=t.b,o=t.d;let a=1/(s*o-n*i);return new e(a*o,a*-n,a*-i,a*s)}}function i(t,s,e){return Math.max(s,Math.min(t,e))}var n,o;!function(t){t[t.FACE_A_X=0]="FACE_A_X",t[t.FACE_A_Y=1]="FACE_A_Y",t[t.FACE_B_X=2]="FACE_B_X",t[t.FACE_B_Y=3]="FACE_B_Y"}(n||(n={})),function(t){t[t.NO_EDGE=0]="NO_EDGE",t[t.EDGE1=1]="EDGE1",t[t.EDGE2=2]="EDGE2",t[t.EDGE3=3]="EDGE3",t[t.EDGE4=4]="EDGE4"}(o||(o={}));class a{constructor(){this.inEdge1=o.NO_EDGE,this.outEdge1=o.NO_EDGE,this.inEdge2=o.NO_EDGE,this.outEdge2=o.NO_EDGE}}class r{constructor(){this.e=new a,this.value=0}flip(){const t=this.e,s=t.inEdge1,e=t.outEdge1;t.inEdge1=t.inEdge2,t.inEdge2=s,t.outEdge1=t.outEdge2,t.outEdge2=e}}class l{constructor(){this.v=new t,this.fp=new r}}function c(s,i,n,a,r,c){let d=e.transpose(a),h=new t(-(d.a*r+d.b*c),-(d.c*r+d.d*c)),u=t.abs(h);const y=new l,E=new l;u.x>u.y?Math.sign(h.x)>0?(y.v.set(i.x,-i.y),y.fp.e.inEdge2=o.EDGE3,y.fp.e.outEdge2=o.EDGE4,E.v.set(i.x,i.y),E.fp.e.inEdge2=o.EDGE4,E.fp.e.outEdge2=o.EDGE1):(y.v.set(-i.x,i.y),y.fp.e.inEdge2=o.EDGE1,y.fp.e.outEdge2=o.EDGE2,E.v.set(-i.x,-i.y),E.fp.e.inEdge2=o.EDGE2,E.fp.e.outEdge2=o.EDGE3):Math.sign(h.y)>0?(y.v.set(i.x,i.y),y.fp.e.inEdge2=o.EDGE4,y.fp.e.outEdge2=o.EDGE1,E.v.set(-i.x,i.y),E.fp.e.inEdge2=o.EDGE1,E.fp.e.outEdge2=o.EDGE2):(y.v.set(-i.x,-i.y),y.fp.e.inEdge2=o.EDGE2,y.fp.e.outEdge2=o.EDGE3,E.v.set(i.x,-i.y),E.fp.e.inEdge2=o.EDGE3,E.fp.e.outEdge2=o.EDGE4);const b=y.v,m=E.v;let v=n.x+(a.a*b.x+a.b*b.y),V=n.y+(a.c*b.x+a.d*b.y);b.set(v,V),v=n.x+(a.a*m.x+a.b*m.y),V=n.y+(a.c*m.x+a.d*m.y),m.set(v,V),s[0]=y,s[1]=E}class d{constructor(){this.position=new t,this.normal=new t,this.r1=new t,this.r2=new t,this.separation=0,this.Pn=0,this.Pt=0,this.Pnb=0,this.massNormal=0,this.massTangent=0,this.bias=0,this.feature=new r}}function h(s,e,i,n,a,r){let c=0,d=t.dotXYV(i,n,e[0].v)-a,h=t.dotXYV(i,n,e[1].v)-a;if(d<=0&&(s[c]=e[0],c++),h<=0&&(s[c]=e[1],c++),d*h<0){let t=d/(d-h),i=new l;i.v.set(e[0].v.x+t*(e[1].v.x-e[0].v.x),e[0].v.y+t*(e[1].v.y-e[0].v.y)),d>0?(i.fp=e[0].fp,i.fp.e.inEdge1=r,i.fp.e.inEdge2=o.NO_EDGE):(i.fp=e[1].fp,i.fp.e.outEdge1=r,i.fp.e.outEdge2=o.NO_EDGE),s[c]=i,c++}return c}function u(s,i,a){let r=t.mulSV(.5,i.width),l=t.mulSV(.5,a.width),u=i.position,y=a.position,E=(new e).set(i.rotation),b=(new e).set(a.rotation),m=e.transpose(E),v=e.transpose(b),V=t.sub(y,u),w=e.mulMV(m,V),p=e.mulMV(v,V),x=e.mulMM(m,b),f=e.abs(x),g=e.transpose(f),M=t.sub(t.sub(t.abs(w),r),e.mulMV(f,l));if(M.x>0||M.y>0)return 0;let _=t.sub(t.sub(t.abs(p),e.mulMV(g,r)),l);if(_.x>0||_.y>0)return 0;let I=n.FACE_A_X,S=M.x,A=0,D=0;w.x>0?(A=E.a,D=E.c):(A=-E.a,D=-E.c);M.y>.95*S+.01*r.y&&(I=n.FACE_A_Y,S=M.y,w.y>0?(A=E.b,D=E.d):(A=-E.b,D=-E.d)),_.x>.95*S+.01*l.x&&(I=n.FACE_B_X,S=_.x,p.x>0?(A=b.a,D=b.c):(A=-b.a,D=-b.c)),_.y>.95*S+.01*l.y&&(I=n.FACE_B_Y,S=_.y,p.y>0?(A=b.b,D=b.d):(A=-b.b,D=-b.d));let G=A,P=D,C=[],X=null;if(I===n.FACE_A_X?X=function(s,e,i,n,a,r,l,d,u){let y=t.dotXYV(l,d,s)+a.x,E=i.b,b=i.d,m=t.dotXYV(E,b,s),v=-m+a.y,V=m+a.y,w=[];c(w,r,e,n,l,d);let p=[],x=h(p,w,-E,-b,v,o.EDGE3);return x<2?null:(x=h(u,p,E,b,V,o.EDGE1),x<2?null:y)}(u,y,E,b,r,l,G,P,C):I===n.FACE_A_Y?X=function(s,e,i,n,a,r,l,d,u){let y=t.dotXYV(l,d,s)+a.y,E=i.a,b=i.c,m=t.dotXYV(E,b,s),v=-m+a.x,V=m+a.x,w=[];c(w,r,e,n,l,d);let p=[],x=h(p,w,-E,-b,v,o.EDGE2);return x<2?null:(x=h(u,p,E,b,V,o.EDGE4),x<2?null:y)}(u,y,E,b,r,l,G,P,C):I===n.FACE_B_X?(G=-A,P=-D,X=function(s,e,i,n,a,r,l,d,u){let y=t.dotXYV(l,d,e)+r.x,E=n.b,b=n.d,m=t.dotXYV(E,b,e),v=-m+r.y,V=m+r.y,w=[];c(w,a,s,i,l,d);let p=[],x=h(p,w,-E,-b,v,o.EDGE3);return x<2?null:(x=h(u,p,E,b,V,o.EDGE1),x<2?null:y)}(u,y,E,b,r,l,G,P,C)):I===n.FACE_B_Y&&(G=-A,P=-D,X=function(s,e,i,n,a,r,l,d,u){let y=t.dotXYV(l,d,e)+r.y,E=n.a,b=n.c,m=t.dotXYV(E,b,e),v=-m+r.x,V=m+r.x,w=[];c(w,a,s,i,l,d);let p=[],x=h(p,w,-E,-b,v,o.EDGE2);return x<2?null:(x=h(u,p,E,b,V,o.EDGE4),x<2?null:y)}(u,y,E,b,r,l,G,P,C)),null===X)return 0;let B=0;for(let e=0;e<2;e++){let i=t.dotXYV(G,P,C[e].v)-X;i<=0&&(s[B]=new d,s[B].separation=i,s[B].normal.set(A,D),s[B].position=new t(C[e].v.x-i*G,C[e].v.y-i*P),s[B].feature=C[e].fp,I!==n.FACE_B_X&&I!==n.FACE_B_Y||s[B].feature.flip(),B++)}return B}class y{constructor(t,s,e){this.world=t,s.id<e.id?(this.body1=s,this.body2=e):(this.body1=e,this.body2=s),this.contacts=[],this.numContacts=u(this.contacts,this.body1,this.body2),this.friction=Math.sqrt(this.body1.friction*this.body2.friction)}update(t,s){let e=[],i=this.contacts,n=this.numContacts,o=this.world.warmStarting;for(let a=0;a<s;a++){let s=t[a],r=-1;for(let t=0;t<n;t++){let e=i[t];if(s.feature.value===e.feature.value){r=t;break}}if(r>-1){let t=i[r];o?(s.Pn=t.Pn,s.Pt=t.Pt,s.Pnb=t.Pnb):(s.Pn=0,s.Pt=0,s.Pnb=0),e[a]=s}else e[a]=t[a]}this.contacts=e,this.numContacts=s}preStep(s){let e=this.contacts,i=this.numContacts,n=this.world.positionCorrection?.2:0,o=this.body1,a=this.body2,r=this.world.accumulateImpulses;for(let l=0;l<i;l++){let i=e[l],c=t.sub(i.position,o.position),d=t.sub(i.position,a.position),h=t.dot(c,i.normal),u=t.dot(d,i.normal),y=o.invMass+a.invMass;y+=o.invI*(t.dot(c,c)-h*h)+a.invI*(t.dot(d,d)-u*u),i.massNormal=1/y;let E=t.crossVS(i.normal,1),b=t.dot(c,E),m=t.dot(d,E),v=o.invMass+a.invMass;if(v+=o.invI*(t.dot(c,c)-b*b)+a.invI*(t.dot(d,d)-m*m),i.massTangent=1/v,i.bias=-n*s*Math.min(0,i.separation+.01),r){let s=t.add(t.mulSV(i.Pn,i.normal),t.mulSV(i.Pt,E));o.velocity.sub(t.mulSV(o.invMass,s)),o.angularVelocity-=o.invI*t.crossVV(c,s),a.velocity.add(t.mulSV(a.invMass,s)),a.angularVelocity+=a.invI*t.crossVV(d,s)}}}applyImpulse(){let s=this.contacts,e=this.numContacts,n=this.body1,o=this.body2,a=this.world.accumulateImpulses;for(let r=0;r<e;r++){let e=s[r];e.r1=t.sub(e.position,n.position),e.r2=t.sub(e.position,o.position);let l=t.sub(t.sub(t.add(o.velocity,t.crossSV(o.angularVelocity,e.r2)),n.velocity),t.crossSV(n.angularVelocity,e.r1)),c=t.dot(l,e.normal),d=e.massNormal*(-c+e.bias);if(a){let t=e.Pn;e.Pn=Math.max(t+d,0),d=e.Pn-t}else d=Math.max(d,0);let h=t.mulSV(d,e.normal);n.velocity.sub(t.mulSV(n.invMass,h)),n.angularVelocity-=n.invI*t.crossVV(e.r1,h),o.velocity.add(t.mulSV(o.invMass,h)),o.angularVelocity+=o.invI*t.crossVV(e.r2,h),l=t.sub(t.sub(t.add(o.velocity,t.crossSV(o.angularVelocity,e.r2)),n.velocity),t.crossSV(n.angularVelocity,e.r1));let u=t.crossVS(e.normal,1),y=t.dot(l,u),E=e.massTangent*-y;if(a){let t=this.friction*e.Pn,s=e.Pt;e.Pt=i(s+E,-t,t),E=e.Pt-s}else{let t=this.friction*d;E=i(E,-t,t)}let b=t.mulSV(E,u);n.velocity.sub(t.mulSV(n.invMass,b)),n.angularVelocity-=n.invI*t.crossVV(e.r1,b),o.velocity.add(t.mulSV(o.invMass,b)),o.angularVelocity+=o.invI*t.crossVV(e.r2,b)}}}class E{constructor(t,s){this.bodyA=t,this.bodyB=s,this.value=t.id+":"+s.id}}class b{constructor(t,s){this.first=t,this.second=s}}window.vec2Total=0,window.mat22Total=0;let m,v=new class{constructor(s=new t(0,9.807),e=10){this.bodyIdSeed=0,this.bodies=[],this.joints=[],this.arbiters=[],this.gravity=new t,this.iterations=10,this.accumulateImpulses=!0,this.warmStarting=!0,this.positionCorrection=!0,this.gravity.x=s.x,this.gravity.y=s.y,this.iterations=e}addBody(t){return this.bodyIdSeed++,t.id=this.bodyIdSeed,this.bodies.push(t),this}addJoint(t){return this.joints.push(t),this}clear(){return this.bodies=[],this.joints=[],this.arbiters=[],this}broadPhase(){let t=this.bodies,s=t.length,e=this.arbiters;for(let i=0;i<s-1;i++){let n=t[i];for(let o=i+1;o<s;o++){let s=t[o];if(0===n.invMass&&0===s.invMass)continue;let i=new y(this,n,s),a=new E(n,s),r=-1;for(let t=0;t<e.length;t++)if(e[t].first.value===a.value){r=t;break}i.numContacts>0?-1===r?e.push(new b(a,i)):e[r].second.update(i.contacts,i.numContacts):0===i.numContacts&&r>-1&&e.splice(r,1)}}}step(s){let e=s>0?1/s:0;this.broadPhase();const i=this.bodies,n=this.gravity;for(let e=0;e<i.length;e++){let o=i[e];0!==o.invMass&&(o.velocity.add(t.mulSV(s,t.add(n,t.mulSV(o.invMass,o.force)))),o.angularVelocity+=s*o.invI*o.torque)}const o=this.arbiters,a=this.joints;for(let t=0;t<o.length;t++)o[t].second.preStep(e);for(let t=0;t<a.length;t++)a[t].preStep(e);for(let t=0;t<this.iterations;t++){for(let t=0;t<o.length;t++)o[t].second.applyImpulse();for(let t=0;t<a.length;t++)a[t].applyImpulse()}for(let e=0;e<i.length;e++){let n=i[e];n.position.add(t.mulSV(s,n.velocity)),n.rotation+=s*n.angularVelocity,n.force.set(0,0),n.torque=0}}}(new t(0,40),10),V=new s(new t(2e3,80),Number.MAX_VALUE);V.position.set(500,500),v.addBody(V);let w=new t(300,-150);for(let e=0;e<10;e++)for(let i=0;i<10;i++)m=new s(new t(12,12),5),m.position.set(w.x+16*e,w.y+16*i),m.velocity.y=-50+i,v.addBody(m);let p=new s(new t(25,25),Number.MAX_VALUE);p.position.set(530,50),v.addBody(p);let x=new s(new t(50,50),900);x.position.set(685,40),v.addBody(x);let f=new class{constructor(){this.M=new e,this.localAnchor1=new t,this.localAnchor2=new t,this.r1=new t,this.r2=new t,this.bias=new t,this.P=new t,this.biasFactor=.2,this.softness=0}set(s,i,n,o){this.world=s,this.body1=i,this.body2=n;let a=(new e).set(i.rotation),r=(new e).set(n.rotation),l=e.transpose(a),c=e.transpose(r);this.localAnchor1=e.mulMV(l,t.sub(o,i.position)),this.localAnchor2=e.mulMV(c,t.sub(o,n.position))}preStep(s){const i=this.body1,n=this.body2;let o=(new e).set(i.rotation),a=(new e).set(n.rotation),r=e.mulMV(o,this.localAnchor1),l=e.mulMV(a,this.localAnchor2),c=new e(i.invMass+n.invMass,0,0,i.invMass+n.invMass),d=new e(i.invI*r.y*r.y,-i.invI*r.x*r.y,-i.invI*r.x*r.y,i.invI*r.x*r.x),h=new e(n.invI*l.y*l.y,-n.invI*l.x*l.y,-n.invI*l.x*l.y,n.invI*l.x*l.x),u=e.add(e.add(c,d),h);u.a+=this.softness,u.d+=this.softness,this.M=e.invert(u);let y=t.add(i.position,r),E=t.add(n.position,l),b=t.sub(E,y);this.world.positionCorrection?this.bias=t.mulSV(-this.biasFactor,t.mulSV(s,b)):this.bias.set(0,0),this.world.warmStarting?(i.velocity.sub(t.mulSV(i.invMass,this.P)),i.angularVelocity-=i.invI*t.crossVV(r,this.P),n.velocity.add(t.mulSV(n.invMass,this.P)),n.angularVelocity+=n.invI*t.crossVV(l,this.P)):this.P.set(0,0),this.r1=r,this.r2=l}applyImpulse(){const s=this.body1,i=this.body2,n=this.r1,o=this.r2;let a=t.sub(t.sub(t.add(i.velocity,t.crossSV(i.angularVelocity,o)),s.velocity),t.crossSV(s.angularVelocity,n)),r=new t;r=e.mulMV(this.M,t.sub(t.sub(this.bias,a),t.mulSV(this.softness,this.P))),s.velocity.sub(t.mulSV(s.invMass,r)),s.angularVelocity-=s.invI*t.crossVV(n,r),i.velocity.add(t.mulSV(i.invMass,r)),i.angularVelocity+=i.invI*t.crossVV(o,r),this.P.add(r)}};f.set(v,p,x,p.position),v.addJoint(f);let g=new class{constructor(t){this.canvas=t,this.context=t.getContext("2d")}render(t){const s=this.context,e=t.bodies,i=t.joints,n=t.arbiters;s.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<e.length;t++)this.renderBody(e[t],s);for(let t=0;t<n.length;t++){let e=n[t].second;for(let t=0;t<e.contacts.length;t++)this.renderContact(e.contacts[t],s)}for(let t=0;t<i.length;t++)this.renderJoint(i[t],s)}renderBody(s,i){let n=(new e).set(s.rotation),o=s.position,a=t.mulSV(.5,s.width),r=t.add(o,e.mulMV(n,new t(-a.x,-a.y))),l=t.add(o,e.mulMV(n,new t(a.x,-a.y))),c=t.add(o,e.mulMV(n,new t(a.x,a.y))),d=t.add(o,e.mulMV(n,new t(-a.x,a.y))),h=t.add(o,e.mulMV(n,new t(a.x,0)));i.strokeStyle="black",i.lineWidth=.5,i.beginPath(),i.arc(s.position.x,s.position.y,2,0,2*Math.PI),i.stroke(),i.beginPath(),i.moveTo(r.x,r.y),i.lineTo(l.x,l.y),i.lineTo(c.x,c.y),i.lineTo(d.x,d.y),i.lineTo(r.x,r.y),i.stroke(),i.beginPath(),i.moveTo(o.x,o.y),i.lineTo(h.x,h.y),i.stroke()}renderContact(t,s){s.strokeStyle="red",s.lineWidth=.5,s.beginPath(),s.arc(t.position.x,t.position.y,2,0,2*Math.PI),s.stroke()}renderJoint(s,i){let n=s.body1,o=s.body2,a=(new e).set(n.rotation),r=(new e).set(o.rotation),l=n.position,c=t.add(l,e.mulMV(a,s.localAnchor1)),d=o.position,h=t.add(d,e.mulMV(r,s.localAnchor2));i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(c.x,c.y),i.lineTo(d.x,d.y),i.lineTo(h.x,h.y),i.stroke()}}(document.getElementById("demo")),M=!0,_=0,I=document.getElementById("frame"),S=document.getElementById("vec2"),A=document.getElementById("mat22"),D=document.getElementById("frame200"),G=document.getElementById("frame600");document.getElementById("pause").addEventListener("click",()=>{M=!M}),function t(){window.vec2Total=0,window.mat22Total=0,M||(v.step(1/30),g.render(v),I.value=_.toString(),S.value=window.vec2Total.toString(),A.value=window.mat22Total.toString(),200===_?D.value=S.value:600===_&&(G.value=S.value),_++),requestAnimationFrame(t)}()}();
