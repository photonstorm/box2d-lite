!function(){"use strict";class t{constructor(t=0,s=0){this.x=t,this.y=s,window.vec2Total++}set(t=0,s=0){this.x=t,this.y=s}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}mul(t){this.x*=t,this.y*=t}static add(s,e){return new t(s.x+e.x,s.y+e.y)}static sub(s,e){return new t(s.x-e.x,s.y-e.y)}static mulVV(s,e){return new t(s.x*e.x,s.y*e.y)}static mulSV(s,e){return new t(s*e.x,s*e.y)}static abs(s){return new t(Math.abs(s.x),Math.abs(s.y))}static neg(s){return new t(-s.x,-s.y)}static dot(t,s){return t.x*s.x+t.y*s.y}static crossVV(t,s){return t.x*s.y-t.y*s.x}static crossVS(s,e){return new t(e*s.y,-e*s.x)}static crossSV(s,e){return new t(-s*e.y,s*e.x)}}class s{constructor(s,e){this.position=new t,this.rotation=0,this.velocity=new t,this.angularVelocity=0,this.force=new t,this.torque=0,this.width=new t,this.friction=.2,this.mass=Number.MAX_VALUE,this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0,this.id=0,this.set(s,e)}set(t,s){return this.width=t,this.mass=s,s<Number.MAX_VALUE?(this.invMass=1/s,this.I=s*(t.x*t.x+t.y*t.y)/12,this.invI=1/this.I):(this.invMass=0,this.I=Number.MAX_VALUE,this.invI=0),this}addForce(t){return this.force.add(t),this}}class e{constructor(s,e){if(this.col1=new t,this.col2=new t,"number"==typeof s&&void 0===e){const t=Math.cos(s),e=Math.sin(s);this.col1.set(t,e),this.col2.set(-e,t)}else"object"==typeof s&&"object"==typeof e&&(this.col1=s,this.col2=e);window.mat22Total++}static add(s,i){return new e(t.add(s.col1,i.col1),t.add(s.col2,i.col2))}static mulMV(s,e){return new t(s.col1.x*e.x+s.col2.x*e.y,s.col1.y*e.x+s.col2.y*e.y)}static mulMM(t,s){return new e(e.mulMV(t,s.col1),e.mulMV(t,s.col2))}static abs(s){return new e(t.abs(s.col1),t.abs(s.col2))}static transpose(s){return new e(new t(s.col1.x,s.col2.x),new t(s.col1.y,s.col2.y))}static invert(t){const s=t.col1.x,i=t.col2.x,o=t.col1.y,n=t.col2.y,l=new e;let a=s*n-i*o;return a=1/a,l.col1.x=a*n,l.col2.x=a*-i,l.col1.y=a*-o,l.col2.y=a*s,l}}function i(t,s,e){return Math.max(s,Math.min(t,e))}var o,n;!function(t){t[t.FACE_A_X=0]="FACE_A_X",t[t.FACE_A_Y=1]="FACE_A_Y",t[t.FACE_B_X=2]="FACE_B_X",t[t.FACE_B_Y=3]="FACE_B_Y"}(o||(o={})),function(t){t[t.NO_EDGE=0]="NO_EDGE",t[t.EDGE1=1]="EDGE1",t[t.EDGE2=2]="EDGE2",t[t.EDGE3=3]="EDGE3",t[t.EDGE4=4]="EDGE4"}(n||(n={}));class l{constructor(){this.inEdge1=n.NO_EDGE,this.outEdge1=n.NO_EDGE,this.inEdge2=n.NO_EDGE,this.outEdge2=n.NO_EDGE}}class a{constructor(){this.e=new l,this.value=0}flip(){const t=this.e,s=t.inEdge1,e=t.outEdge1;t.inEdge1=t.inEdge2,t.inEdge2=s,t.outEdge1=t.outEdge2,t.outEdge2=e}}class r{constructor(){this.v=new t,this.fp=new a}}function c(s,i,o,l,a){let c=e.transpose(l),d=t.neg(e.mulMV(c,a)),h=t.abs(d);const u=new r,y=new r;h.x>h.y?Math.sign(d.x)>0?(u.v.set(i.x,-i.y),u.fp.e.inEdge2=n.EDGE3,u.fp.e.outEdge2=n.EDGE4,y.v.set(i.x,i.y),y.fp.e.inEdge2=n.EDGE4,y.fp.e.outEdge2=n.EDGE1):(u.v.set(-i.x,i.y),u.fp.e.inEdge2=n.EDGE1,u.fp.e.outEdge2=n.EDGE2,y.v.set(-i.x,-i.y),y.fp.e.inEdge2=n.EDGE2,y.fp.e.outEdge2=n.EDGE3):Math.sign(d.y)>0?(u.v.set(i.x,i.y),u.fp.e.inEdge2=n.EDGE4,u.fp.e.outEdge2=n.EDGE1,y.v.set(-i.x,i.y),y.fp.e.inEdge2=n.EDGE1,y.fp.e.outEdge2=n.EDGE2):(u.v.set(-i.x,-i.y),u.fp.e.inEdge2=n.EDGE2,u.fp.e.outEdge2=n.EDGE3,y.v.set(i.x,-i.y),y.fp.e.inEdge2=n.EDGE3,y.fp.e.outEdge2=n.EDGE4),u.v=t.add(o,e.mulMV(l,u.v)),y.v=t.add(o,e.mulMV(l,y.v)),s[0]=u,s[1]=y}class d{constructor(){this.position=new t,this.normal=new t,this.r1=new t,this.r2=new t,this.separation=0,this.Pn=0,this.Pt=0,this.Pnb=0,this.massNormal=0,this.massTangent=0,this.bias=0,this.feature=new a}}function h(s,e,i,o,l){let a=0,c=t.dot(i,e[0].v)-o,d=t.dot(i,e[1].v)-o;if(c<=0&&(s[a]=e[0],a++),d<=0&&(s[a]=e[1],a++),c*d<0){let i=c/(c-d);s[a]=new r,s[a].v=t.add(e[0].v,t.mulSV(i,t.sub(e[1].v,e[0].v))),c>0?(s[a].fp=e[0].fp,s[a].fp.e.inEdge1=l,s[a].fp.e.inEdge2=n.NO_EDGE):(s[a].fp=e[1].fp,s[a].fp.e.outEdge1=l,s[a].fp.e.outEdge2=n.NO_EDGE),a++}return a}class u{constructor(s,i,l){this.world=s,i.id<l.id?(this.body1=i,this.body2=l):(this.body1=l,this.body2=i),this.contacts=[],this.numContacts=function(s,i,l){let a=t.mulSV(.5,i.width),r=t.mulSV(.5,l.width),u=i.position,y=l.position,E=new e(i.rotation),m=new e(l.rotation),v=e.transpose(E),w=e.transpose(m),b=t.sub(y,u),V=e.mulMV(v,b),p=e.mulMV(w,b),x=e.mulMM(v,m),g=e.abs(x),f=e.transpose(g),M=t.sub(t.sub(t.abs(V),a),e.mulMV(g,r));if(M.x>0||M.y>0)return 0;let S=t.sub(t.sub(t.abs(p),e.mulMV(f,a)),r);if(S.x>0||S.y>0)return 0;let _,A,I=o.FACE_A_X,D=M.x,G=V.x>0?E.col1:t.neg(E.col1);M.y>.95*D+.01*a.y&&(I=o.FACE_A_Y,D=M.y,G=V.y>0?E.col2:t.neg(E.col2)),S.x>.95*D+.01*r.x&&(I=o.FACE_B_X,D=S.x,G=p.x>0?m.col1:t.neg(m.col1)),S.y>.95*D+.01*r.y&&(I=o.FACE_B_Y,D=S.y,G=p.y>0?m.col2:t.neg(m.col2));let P,C,B,F,T,N,X=[];switch(I){case o.FACE_A_X:_=G,P=t.dot(u,_)+a.x,A=E.col2,N=t.dot(u,A),C=-N+a.y,B=N+a.y,F=n.EDGE3,T=n.EDGE1,c(X,r,y,m,_);break;case o.FACE_A_Y:_=G,P=t.dot(u,_)+a.y,A=E.col1,N=t.dot(u,A),C=-N+a.x,B=N+a.x,F=n.EDGE2,T=n.EDGE4,c(X,r,y,m,_);break;case o.FACE_B_X:_=t.neg(G),P=t.dot(y,_)+r.x,A=m.col2,N=t.dot(y,A),C=-N+r.y,B=N+r.y,F=n.EDGE3,T=n.EDGE1,c(X,a,u,E,_);break;case o.FACE_B_Y:_=t.neg(G),P=t.dot(y,_)+r.y,A=m.col1,N=t.dot(y,A),C=-N+r.x,B=N+r.x,F=n.EDGE2,T=n.EDGE4,c(X,a,u,E,_)}let k=[],Y=[],O=h(k,X,t.neg(A),C,F);if(O<2)return 0;if(O=h(Y,k,A,B,T),O<2)return 0;let j=0;for(let e=0;e<2;e++){let i=t.dot(_,Y[e].v)-P;i<=0&&(s[j]=new d,s[j].separation=i,s[j].normal=G,s[j].position=t.sub(Y[e].v,t.mulSV(i,_)),s[j].feature=Y[e].fp,I!==o.FACE_B_X&&I!==o.FACE_B_Y||s[j].feature.flip(),j++)}return j}(this.contacts,this.body1,this.body2),this.friction=Math.sqrt(this.body1.friction*this.body2.friction)}update(t,s){let e=[],i=this.contacts,o=this.numContacts,n=this.world.warmStarting;for(let l=0;l<s;l++){let s=t[l],a=-1;for(let t=0;t<o;t++){let e=i[t];if(s.feature.value===e.feature.value){a=t;break}}if(a>-1){let t=i[a];n?(s.Pn=t.Pn,s.Pt=t.Pt,s.Pnb=t.Pnb):(s.Pn=0,s.Pt=0,s.Pnb=0),e[l]=s}else e[l]=t[l]}this.contacts=e,this.numContacts=s}preStep(s){let e=this.contacts,i=this.numContacts,o=this.world.positionCorrection?.2:0,n=this.body1,l=this.body2,a=this.world.accumulateImpulses;for(let r=0;r<i;r++){let i=e[r],c=t.sub(i.position,n.position),d=t.sub(i.position,l.position),h=t.dot(c,i.normal),u=t.dot(d,i.normal),y=n.invMass+l.invMass;y+=n.invI*(t.dot(c,c)-h*h)+l.invI*(t.dot(d,d)-u*u),i.massNormal=1/y;let E=t.crossVS(i.normal,1),m=t.dot(c,E),v=t.dot(d,E),w=n.invMass+l.invMass;if(w+=n.invI*(t.dot(c,c)-m*m)+l.invI*(t.dot(d,d)-v*v),i.massTangent=1/w,i.bias=-o*s*Math.min(0,i.separation+.01),a){let s=t.add(t.mulSV(i.Pn,i.normal),t.mulSV(i.Pt,E));n.velocity.sub(t.mulSV(n.invMass,s)),n.angularVelocity-=n.invI*t.crossVV(c,s),l.velocity.add(t.mulSV(l.invMass,s)),l.angularVelocity+=l.invI*t.crossVV(d,s)}}}applyImpulse(){let s=this.contacts,e=this.numContacts,o=this.body1,n=this.body2,l=this.world.accumulateImpulses;for(let a=0;a<e;a++){let e=s[a];e.r1=t.sub(e.position,o.position),e.r2=t.sub(e.position,n.position);let r=t.sub(t.sub(t.add(n.velocity,t.crossSV(n.angularVelocity,e.r2)),o.velocity),t.crossSV(o.angularVelocity,e.r1)),c=t.dot(r,e.normal),d=e.massNormal*(-c+e.bias);if(l){let t=e.Pn;e.Pn=Math.max(t+d,0),d=e.Pn-t}else d=Math.max(d,0);let h=t.mulSV(d,e.normal);o.velocity.sub(t.mulSV(o.invMass,h)),o.angularVelocity-=o.invI*t.crossVV(e.r1,h),n.velocity.add(t.mulSV(n.invMass,h)),n.angularVelocity+=n.invI*t.crossVV(e.r2,h),r=t.sub(t.sub(t.add(n.velocity,t.crossSV(n.angularVelocity,e.r2)),o.velocity),t.crossSV(o.angularVelocity,e.r1));let u=t.crossVS(e.normal,1),y=t.dot(r,u),E=e.massTangent*-y;if(l){let t=this.friction*e.Pn,s=e.Pt;e.Pt=i(s+E,-t,t),E=e.Pt-s}else{let t=this.friction*d;E=i(E,-t,t)}let m=t.mulSV(E,u);o.velocity.sub(t.mulSV(o.invMass,m)),o.angularVelocity-=o.invI*t.crossVV(e.r1,m),n.velocity.add(t.mulSV(n.invMass,m)),n.angularVelocity+=n.invI*t.crossVV(e.r2,m)}}}class y{constructor(t,s){this.bodyA=t,this.bodyB=s,this.value=t.id+":"+s.id}}class E{constructor(t,s){this.first=t,this.second=s}}window.vec2Total=0,window.mat22Total=0;let m,v=new class{constructor(s=new t(0,9.807),e=10){this.bodyIdSeed=0,this.bodies=[],this.joints=[],this.arbiters=[],this.gravity=new t,this.iterations=10,this.accumulateImpulses=!0,this.warmStarting=!0,this.positionCorrection=!0,this.gravity.x=s.x,this.gravity.y=s.y,this.iterations=e}addBody(t){return this.bodyIdSeed++,t.id=this.bodyIdSeed,this.bodies.push(t),this}addJoint(t){return this.joints.push(t),this}clear(){return this.bodies=[],this.joints=[],this.arbiters=[],this}broadPhase(){let t=this.bodies,s=t.length,e=this.arbiters;for(let i=0;i<s-1;i++){let o=t[i];for(let n=i+1;n<s;n++){let s=t[n];if(0===o.invMass&&0===s.invMass)continue;let i=new u(this,o,s),l=new y(o,s),a=-1;for(let t=0;t<e.length;t++)if(e[t].first.value===l.value){a=t;break}i.numContacts>0?-1===a?e.push(new E(l,i)):e[a].second.update(i.contacts,i.numContacts):0===i.numContacts&&a>-1&&e.splice(a,1)}}}step(s){let e=s>0?1/s:0;this.broadPhase();const i=this.bodies,o=this.gravity;for(let e=0;e<i.length;e++){let n=i[e];0!==n.invMass&&(n.velocity.add(t.mulSV(s,t.add(o,t.mulSV(n.invMass,n.force)))),n.angularVelocity+=s*n.invI*n.torque)}const n=this.arbiters,l=this.joints;for(let t=0;t<n.length;t++)n[t].second.preStep(e);for(let t=0;t<l.length;t++)l[t].preStep(e);for(let t=0;t<this.iterations;t++){for(let t=0;t<n.length;t++)n[t].second.applyImpulse();for(let t=0;t<l.length;t++)l[t].applyImpulse()}for(let e=0;e<i.length;e++){let o=i[e];o.position.add(t.mulSV(s,o.velocity)),o.rotation+=s*o.angularVelocity,o.force.set(0,0),o.torque=0}}}(new t(0,40),10),w=new s(new t(2e3,80),Number.MAX_VALUE);w.position.set(500,500),v.addBody(w);let b=new t(300,-150);for(let e=0;e<10;e++)for(let i=0;i<10;i++)m=new s(new t(12,12),5),m.position.set(b.x+16*e,b.y+16*i),m.velocity.y=-50+i,v.addBody(m);let V=new s(new t(25,25),Number.MAX_VALUE);V.position.set(530,50),v.addBody(V);let p=new s(new t(50,50),900);p.position.set(685,40),v.addBody(p);let x=new class{constructor(){this.M=new e,this.localAnchor1=new t,this.localAnchor2=new t,this.r1=new t,this.r2=new t,this.bias=new t,this.P=new t,this.biasFactor=.2,this.softness=0}set(s,i,o,n){this.world=s,this.body1=i,this.body2=o;let l=new e(i.rotation),a=new e(o.rotation),r=e.transpose(l),c=e.transpose(a);this.localAnchor1=e.mulMV(r,t.sub(n,i.position)),this.localAnchor2=e.mulMV(c,t.sub(n,o.position))}preStep(s){const i=this.body1,o=this.body2;let n=new e(i.rotation),l=new e(o.rotation),a=e.mulMV(n,this.localAnchor1),r=e.mulMV(l,this.localAnchor2),c=new e;c.col1.x=i.invMass+o.invMass,c.col1.y=0,c.col2.x=0,c.col2.y=i.invMass+o.invMass;let d=new e;d.col1.x=i.invI*a.y*a.y,d.col1.y=-i.invI*a.x*a.y,d.col2.x=-i.invI*a.x*a.y,d.col2.y=i.invI*a.x*a.x;let h=new e;h.col1.x=o.invI*r.y*r.y,h.col1.y=-o.invI*r.x*r.y,h.col2.x=-o.invI*r.x*r.y,h.col2.y=o.invI*r.x*r.x;let u=e.add(e.add(c,d),h);u.col1.x+=this.softness,u.col2.y+=this.softness,this.M=e.invert(u);let y=t.add(i.position,a),E=t.add(o.position,r),m=t.sub(E,y);this.world.positionCorrection?this.bias=t.mulSV(-this.biasFactor,t.mulSV(s,m)):this.bias.set(0,0),this.world.warmStarting?(i.velocity.sub(t.mulSV(i.invMass,this.P)),i.angularVelocity-=i.invI*t.crossVV(a,this.P),o.velocity.add(t.mulSV(o.invMass,this.P)),o.angularVelocity+=o.invI*t.crossVV(r,this.P)):this.P.set(0,0),this.r1=a,this.r2=r}applyImpulse(){const s=this.body1,i=this.body2,o=this.r1,n=this.r2;let l=t.sub(t.sub(t.add(i.velocity,t.crossSV(i.angularVelocity,n)),s.velocity),t.crossSV(s.angularVelocity,o)),a=new t;a=e.mulMV(this.M,t.sub(t.sub(this.bias,l),t.mulSV(this.softness,this.P))),s.velocity.sub(t.mulSV(s.invMass,a)),s.angularVelocity-=s.invI*t.crossVV(o,a),i.velocity.add(t.mulSV(i.invMass,a)),i.angularVelocity+=i.invI*t.crossVV(n,a),this.P.add(a)}};x.set(v,V,p,V.position),v.addJoint(x);let g=new class{constructor(t){this.canvas=t,this.context=t.getContext("2d")}render(t){const s=this.context,e=t.bodies,i=t.joints,o=t.arbiters;s.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<e.length;t++)this.renderBody(e[t],s);for(let t=0;t<o.length;t++){let e=o[t].second;for(let t=0;t<e.contacts.length;t++)this.renderContact(e.contacts[t],s)}for(let t=0;t<i.length;t++)this.renderJoint(i[t],s)}renderBody(s,i){let o=new e(s.rotation),n=s.position,l=t.mulSV(.5,s.width),a=t.add(n,e.mulMV(o,new t(-l.x,-l.y))),r=t.add(n,e.mulMV(o,new t(l.x,-l.y))),c=t.add(n,e.mulMV(o,new t(l.x,l.y))),d=t.add(n,e.mulMV(o,new t(-l.x,l.y))),h=t.add(n,e.mulMV(o,new t(l.x,0)));i.strokeStyle="black",i.lineWidth=.5,i.beginPath(),i.arc(s.position.x,s.position.y,2,0,2*Math.PI),i.stroke(),i.beginPath(),i.moveTo(a.x,a.y),i.lineTo(r.x,r.y),i.lineTo(c.x,c.y),i.lineTo(d.x,d.y),i.lineTo(a.x,a.y),i.stroke(),i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(h.x,h.y),i.stroke()}renderContact(t,s){s.strokeStyle="red",s.lineWidth=.5,s.beginPath(),s.arc(t.position.x,t.position.y,2,0,2*Math.PI),s.stroke()}renderJoint(s,i){let o=s.body1,n=s.body2,l=new e(o.rotation),a=new e(n.rotation),r=o.position,c=t.add(r,e.mulMV(l,s.localAnchor1)),d=n.position,h=t.add(d,e.mulMV(a,s.localAnchor2));i.beginPath(),i.moveTo(r.x,r.y),i.lineTo(c.x,c.y),i.lineTo(d.x,d.y),i.lineTo(h.x,h.y),i.stroke()}}(document.getElementById("demo")),f=!0,M=0,S=document.getElementById("frame"),_=document.getElementById("vec2"),A=document.getElementById("mat22");document.getElementById("pause").addEventListener("click",()=>{f=!f}),function t(){window.vec2Total=0,window.mat22Total=0,f||(v.step(1/30),g.render(v),M++,S.value=M.toString(),_.value=window.vec2Total.toString(),A.value=window.mat22Total.toString()),requestAnimationFrame(t)}()}();
